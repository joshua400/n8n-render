"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var runAgent_exports = {};
__export(runAgent_exports, {
  runAgent: () => runAgent
});
module.exports = __toCommonJS(runAgent_exports);
var import_agent_execution = require("../../../../../../../utils/agent-execution");
var import_prompt = require("../../prompt");
var import_buildResponseMetadata = require("./buildResponseMetadata");
async function runAgent(ctx, executor, itemContext, model, memory, response) {
  const { itemIndex, input, steps, tools, options } = itemContext;
  const invokeParams = {
    steps,
    input,
    system_message: options.systemMessage ?? import_prompt.SYSTEM_MESSAGE,
    formatting_instructions: "IMPORTANT: For your response to user, you MUST use the `format_final_json_response` tool with your complete answer formatted according to the required schema. Do not attempt to format the JSON manually - always use this tool. Your response will be rejected if it is not properly formatted through this tool. Only use this tool once you are ready to provide your final answer."
  };
  const executeOptions = { signal: ctx.getExecutionCancelSignal() };
  const isStreamingAvailable = "isStreaming" in ctx ? ctx.isStreaming?.() : void 0;
  if ("isStreaming" in ctx && options.enableStreaming && isStreamingAvailable && ctx.getNode().typeVersion >= 2.1) {
    const chatHistory = await (0, import_agent_execution.loadMemory)(memory, model, options.maxTokensFromMemory);
    const eventStream = executor.streamEvents(
      {
        ...invokeParams,
        chat_history: chatHistory
      },
      {
        version: "v2",
        ...executeOptions
      }
    );
    const result = await (0, import_agent_execution.processEventStream)(ctx, eventStream, itemIndex);
    if (result.toolCalls && result.toolCalls.length > 0) {
      const actions = await (0, import_agent_execution.createEngineRequests)(result.toolCalls, itemIndex, tools);
      return {
        actions,
        metadata: (0, import_buildResponseMetadata.buildResponseMetadata)(response, itemIndex)
      };
    }
    if (memory && input && result?.output) {
      await (0, import_agent_execution.saveToMemory)(input, result.output, memory, steps);
    }
    if (options.returnIntermediateSteps && steps.length > 0) {
      result.intermediateSteps = steps;
    }
    return result;
  } else {
    const chatHistory = await (0, import_agent_execution.loadMemory)(memory, model, options.maxTokensFromMemory);
    const modelResponse = await executor.invoke({
      ...invokeParams,
      chat_history: chatHistory
    });
    if ("returnValues" in modelResponse) {
      if (memory && input && modelResponse.returnValues.output) {
        await (0, import_agent_execution.saveToMemory)(input, modelResponse.returnValues.output, memory, steps);
      }
      const result = { ...modelResponse.returnValues };
      if (options.returnIntermediateSteps && steps.length > 0) {
        result.intermediateSteps = steps;
      }
      return result;
    }
    const actions = await (0, import_agent_execution.createEngineRequests)(modelResponse, itemIndex, tools);
    return {
      actions,
      metadata: (0, import_buildResponseMetadata.buildResponseMetadata)(response, itemIndex)
    };
  }
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  runAgent
});
//# sourceMappingURL=runAgent.js.map
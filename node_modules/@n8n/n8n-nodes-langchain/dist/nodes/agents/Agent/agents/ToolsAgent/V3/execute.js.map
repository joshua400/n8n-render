{"version":3,"sources":["../../../../../../../nodes/agents/Agent/agents/ToolsAgent/V3/execute.ts"],"sourcesContent":["import { sleep } from 'n8n-workflow';\nimport type {\n\tEngineRequest,\n\tIExecuteFunctions,\n\tINodeExecutionData,\n\tISupplyDataFunctions,\n\tEngineResponse,\n} from 'n8n-workflow';\n\nimport { buildExecutionContext, executeBatch, checkMaxIterations } from './helpers';\nimport type { RequestResponseMetadata } from './types';\n\n/* -----------------------------------------------------------\n   Main Executor Function\n----------------------------------------------------------- */\n/**\n * The main executor method for the Tools Agent V3.\n *\n * This function orchestrates the execution across input batches, handling:\n * - Building shared execution context (models, memory, batching config)\n * - Processing items in batches with continue-on-fail logic\n * - Returning either tool call requests or node output data\n *\n * @param this Execute context. SupplyDataContext is passed when agent is used as a tool\n * @param response Optional engine response containing tool call results from previous execution\n * @returns Array of execution data for all processed items, or engine request for tool calls\n */\nexport async function toolsAgentExecute(\n\tthis: IExecuteFunctions | ISupplyDataFunctions,\n\tresponse?: EngineResponse<RequestResponseMetadata>,\n): Promise<INodeExecutionData[][] | EngineRequest<RequestResponseMetadata>> {\n\tthis.logger.debug('Executing Tools Agent V3');\n\n\t// Check max iterations if this is a continuation of a previous execution\n\tconst maxIterations = this.getNodeParameter('options.maxIterations', 0, 10) as number;\n\tcheckMaxIterations(response, maxIterations, this.getNode());\n\n\tconst returnData: INodeExecutionData[] = [];\n\tlet request: EngineRequest<RequestResponseMetadata> | undefined = undefined;\n\n\t// Build execution context with shared configuration\n\tconst executionContext = await buildExecutionContext(this);\n\tconst { items, batchSize, delayBetweenBatches, model, fallbackModel, memory } = executionContext;\n\n\t// Process items in batches\n\tfor (let i = 0; i < items.length; i += batchSize) {\n\t\tconst batch = items.slice(i, i + batchSize);\n\n\t\tconst { returnData: batchReturnData, request: batchRequest } = await executeBatch(\n\t\t\tthis,\n\t\t\tbatch,\n\t\t\ti,\n\t\t\tmodel,\n\t\t\tfallbackModel,\n\t\t\tmemory,\n\t\t\tresponse,\n\t\t);\n\n\t\t// Collect results from batch\n\t\treturnData.push.apply(returnData, batchReturnData);\n\n\t\t// Collect requests from batch\n\t\tif (batchRequest) {\n\t\t\tif (!request) {\n\t\t\t\trequest = batchRequest;\n\t\t\t} else {\n\t\t\t\trequest.actions.push.apply(request.actions, batchRequest.actions);\n\t\t\t}\n\t\t}\n\n\t\t// Apply delay between batches if configured\n\t\tif (i + batchSize < items.length && delayBetweenBatches > 0) {\n\t\t\tawait sleep(delayBetweenBatches);\n\t\t}\n\t}\n\n\t// Return tool call request if any tools need to be executed\n\tif (request) {\n\t\treturn request;\n\t}\n\n\t// Otherwise return execution data\n\treturn [returnData];\n}\n\n// Re-export types for backwards compatibility\nexport type { RequestResponseMetadata } from './types';\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAsB;AAStB,qBAAwE;AAkBxE,eAAsB,kBAErB,UAC2E;AAC3E,OAAK,OAAO,MAAM,0BAA0B;AAG5C,QAAM,gBAAgB,KAAK,iBAAiB,yBAAyB,GAAG,EAAE;AAC1E,yCAAmB,UAAU,eAAe,KAAK,QAAQ,CAAC;AAE1D,QAAM,aAAmC,CAAC;AAC1C,MAAI,UAA8D;AAGlE,QAAM,mBAAmB,UAAM,sCAAsB,IAAI;AACzD,QAAM,EAAE,OAAO,WAAW,qBAAqB,OAAO,eAAe,OAAO,IAAI;AAGhF,WAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK,WAAW;AACjD,UAAM,QAAQ,MAAM,MAAM,GAAG,IAAI,SAAS;AAE1C,UAAM,EAAE,YAAY,iBAAiB,SAAS,aAAa,IAAI,UAAM;AAAA,MACpE;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACD;AAGA,eAAW,KAAK,MAAM,YAAY,eAAe;AAGjD,QAAI,cAAc;AACjB,UAAI,CAAC,SAAS;AACb,kBAAU;AAAA,MACX,OAAO;AACN,gBAAQ,QAAQ,KAAK,MAAM,QAAQ,SAAS,aAAa,OAAO;AAAA,MACjE;AAAA,IACD;AAGA,QAAI,IAAI,YAAY,MAAM,UAAU,sBAAsB,GAAG;AAC5D,gBAAM,2BAAM,mBAAmB;AAAA,IAChC;AAAA,EACD;AAGA,MAAI,SAAS;AACZ,WAAO;AAAA,EACR;AAGA,SAAO,CAAC,UAAU;AACnB;","names":[]}
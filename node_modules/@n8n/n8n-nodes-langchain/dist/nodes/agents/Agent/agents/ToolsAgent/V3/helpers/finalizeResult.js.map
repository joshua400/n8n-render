{"version":3,"sources":["../../../../../../../../nodes/agents/Agent/agents/ToolsAgent/V3/helpers/finalizeResult.ts"],"sourcesContent":["import type { BaseChatMemory } from '@langchain/classic/memory';\nimport omit from 'lodash/omit';\nimport { jsonParse } from 'n8n-workflow';\nimport type { INodeExecutionData } from 'n8n-workflow';\n\nimport type { N8nOutputParser } from '@utils/output_parsers/N8nOutputParser';\n\nimport type { AgentResult } from '../types';\n\n/**\n * Finalizes the result by parsing output and preparing execution data.\n * Handles output parser integration and memory-based parsing.\n *\n * @param result - The agent result to finalize\n * @param itemIndex - The current item index\n * @param memory - Optional memory for parsing context\n * @param outputParser - Optional output parser for structured responses\n * @returns INodeExecutionData ready for output\n */\nexport function finalizeResult(\n\tresult: AgentResult,\n\titemIndex: number,\n\tmemory: BaseChatMemory | undefined,\n\toutputParser: N8nOutputParser | undefined,\n): INodeExecutionData {\n\t// If memory and outputParser are connected, parse the output.\n\tif (memory && outputParser) {\n\t\tconst parsedOutput = jsonParse<{ output: Record<string, unknown> }>(result.output);\n\t\t// Type assertion needed because parsedOutput can be various types\n\t\tresult.output = (parsedOutput?.output ?? parsedOutput) as unknown as string;\n\t}\n\n\t// Omit internal keys before returning the result.\n\tconst itemResult: INodeExecutionData = {\n\t\tjson: omit(\n\t\t\tresult,\n\t\t\t'system_message',\n\t\t\t'formatting_instructions',\n\t\t\t'input',\n\t\t\t'chat_history',\n\t\t\t'agent_scratchpad',\n\t\t),\n\t\tpairedItem: { item: itemIndex },\n\t};\n\n\treturn itemResult;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,kBAAiB;AACjB,0BAA0B;AAiBnB,SAAS,eACf,QACA,WACA,QACA,cACqB;AAErB,MAAI,UAAU,cAAc;AAC3B,UAAM,mBAAe,+BAA+C,OAAO,MAAM;AAEjF,WAAO,SAAU,cAAc,UAAU;AAAA,EAC1C;AAGA,QAAM,aAAiC;AAAA,IACtC,UAAM,YAAAA;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACD;AAAA,IACA,YAAY,EAAE,MAAM,UAAU;AAAA,EAC/B;AAEA,SAAO;AACR;","names":["omit"]}
{"version":3,"sources":["../../../../../../../../nodes/agents/Agent/agents/ToolsAgent/V3/helpers/prepareItemContext.ts"],"sourcesContent":["import type { ChatPromptTemplate } from '@langchain/core/prompts';\nimport type { DynamicStructuredTool, Tool } from '@langchain/classic/tools';\nimport { NodeOperationError } from 'n8n-workflow';\nimport type { IExecuteFunctions, ISupplyDataFunctions, EngineResponse } from 'n8n-workflow';\n\nimport { buildSteps, type ToolCallData } from '@utils/agent-execution';\nimport { getPromptInputByType } from '@utils/helpers';\nimport { getOptionalOutputParser } from '@utils/output_parsers/N8nOutputParser';\nimport type { N8nOutputParser } from '@utils/output_parsers/N8nOutputParser';\n\nimport { getTools, prepareMessages, preparePrompt } from '../../common';\nimport type { AgentOptions, RequestResponseMetadata } from '../types';\n\n/**\n * Context specific to a single item's processing\n */\nexport type ItemContext = {\n\titemIndex: number;\n\tinput: string;\n\tsteps: ToolCallData[];\n\ttools: Array<DynamicStructuredTool | Tool>;\n\tprompt: ChatPromptTemplate;\n\toptions: AgentOptions;\n\toutputParser: N8nOutputParser | undefined;\n};\n\n/**\n * Prepares the context for processing a single item.\n * This includes loading steps, input, tools, prompt, and options.\n *\n * @param ctx - The execution context\n * @param itemIndex - The index of the item to process\n * @param response - Optional engine response with previous tool calls\n * @returns ItemContext containing all item-specific state\n */\nexport async function prepareItemContext(\n\tctx: IExecuteFunctions | ISupplyDataFunctions,\n\titemIndex: number,\n\tresponse?: EngineResponse<RequestResponseMetadata>,\n): Promise<ItemContext> {\n\tconst steps = buildSteps(response, itemIndex);\n\n\tconst input = getPromptInputByType({\n\t\tctx,\n\t\ti: itemIndex,\n\t\tinputKey: 'text',\n\t\tpromptTypeKey: 'promptType',\n\t});\n\tif (input === undefined) {\n\t\tthrow new NodeOperationError(ctx.getNode(), 'The \"text\" parameter is empty.');\n\t}\n\n\tconst outputParser = await getOptionalOutputParser(ctx, itemIndex);\n\tconst tools = await getTools(ctx, outputParser);\n\tconst options = ctx.getNodeParameter('options', itemIndex) as AgentOptions;\n\n\tif (options.enableStreaming === undefined) {\n\t\toptions.enableStreaming = true;\n\t}\n\n\t// Prepare the prompt messages and prompt template.\n\tconst messages = await prepareMessages(ctx, itemIndex, {\n\t\tsystemMessage: options.systemMessage,\n\t\tpassthroughBinaryImages: options.passthroughBinaryImages ?? true,\n\t\toutputParser,\n\t});\n\tconst prompt: ChatPromptTemplate = preparePrompt(messages);\n\n\treturn {\n\t\titemIndex,\n\t\tinput,\n\t\tsteps,\n\t\ttools,\n\t\tprompt,\n\t\toptions,\n\t\toutputParser,\n\t};\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,0BAAmC;AAGnC,6BAA8C;AAC9C,qBAAqC;AACrC,6BAAwC;AAGxC,oBAAyD;AAyBzD,eAAsB,mBACrB,KACA,WACA,UACuB;AACvB,QAAM,YAAQ,mCAAW,UAAU,SAAS;AAE5C,QAAM,YAAQ,qCAAqB;AAAA,IAClC;AAAA,IACA,GAAG;AAAA,IACH,UAAU;AAAA,IACV,eAAe;AAAA,EAChB,CAAC;AACD,MAAI,UAAU,QAAW;AACxB,UAAM,IAAI,uCAAmB,IAAI,QAAQ,GAAG,gCAAgC;AAAA,EAC7E;AAEA,QAAM,eAAe,UAAM,gDAAwB,KAAK,SAAS;AACjE,QAAM,QAAQ,UAAM,wBAAS,KAAK,YAAY;AAC9C,QAAM,UAAU,IAAI,iBAAiB,WAAW,SAAS;AAEzD,MAAI,QAAQ,oBAAoB,QAAW;AAC1C,YAAQ,kBAAkB;AAAA,EAC3B;AAGA,QAAM,WAAW,UAAM,+BAAgB,KAAK,WAAW;AAAA,IACtD,eAAe,QAAQ;AAAA,IACvB,yBAAyB,QAAQ,2BAA2B;AAAA,IAC5D;AAAA,EACD,CAAC;AACD,QAAM,aAA6B,6BAAc,QAAQ;AAEzD,SAAO;AAAA,IACN;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACD;AACD;","names":[]}
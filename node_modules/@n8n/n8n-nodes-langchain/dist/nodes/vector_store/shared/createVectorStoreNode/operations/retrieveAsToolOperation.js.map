{"version":3,"sources":["../../../../../../nodes/vector_store/shared/createVectorStoreNode/operations/retrieveAsToolOperation.ts"],"sourcesContent":["import type { Embeddings } from '@langchain/core/embeddings';\nimport type { BaseDocumentCompressor } from '@langchain/core/retrievers/document_compressors';\nimport type { VectorStore } from '@langchain/core/vectorstores';\nimport { createToolFromNode } from '@utils/fromAIToolFactory';\nimport { getMetadataFiltersValues } from '@utils/helpers';\nimport { logWrapper } from '@utils/logWrapper';\nimport type { ISupplyDataFunctions, SupplyData } from 'n8n-workflow';\nimport { assert, NodeConnectionTypes, nodeNameToToolName } from 'n8n-workflow';\n\nimport type { VectorStoreNodeConstructorArgs } from '../types';\n\n/**\n * Handles the 'retrieve-as-tool' operation mode\n * Returns a tool that can be used with AI Agent nodes\n */\nexport async function handleRetrieveAsToolOperation<T extends VectorStore = VectorStore>(\n\tcontext: ISupplyDataFunctions,\n\targs: VectorStoreNodeConstructorArgs<T>,\n\tembeddings: Embeddings,\n\titemIndex: number,\n): Promise<SupplyData> {\n\t// Get the tool configuration parameters\n\tconst toolDescription = context.getNodeParameter('toolDescription', itemIndex) as string;\n\n\tconst node = context.getNode();\n\tconst { typeVersion } = node;\n\tconst toolName =\n\t\ttypeVersion < 1.3\n\t\t\t? (context.getNodeParameter('toolName', itemIndex) as string)\n\t\t\t: nodeNameToToolName(node);\n\n\t// Create a Dynamic Tool that wraps vector store search functionality\n\tconst vectorStoreTool = createToolFromNode(node, {\n\t\tname: toolName,\n\t\tdescription: toolDescription,\n\t\textraArgs: [{ key: 'input', description: 'Query to search for. Required' }],\n\t\tfunc: async (query) => {\n\t\t\tconst topK = context.getNodeParameter('topK', itemIndex, 4) as number;\n\t\t\tconst useReranker = context.getNodeParameter('useReranker', itemIndex, false) as boolean;\n\t\t\tconst includeDocumentMetadata = context.getNodeParameter(\n\t\t\t\t'includeDocumentMetadata',\n\t\t\t\titemIndex,\n\t\t\t\ttrue,\n\t\t\t) as boolean;\n\n\t\t\t// Get metadata filters\n\t\t\tconst filter = getMetadataFiltersValues(context, itemIndex);\n\n\t\t\t// Extract the query string - it can be either a string (DynamicTool) or an object with 'input' key (DynamicStructuredTool)\n\t\t\tconst queryString = typeof query === 'string' ? query : query.input;\n\t\t\tassert(typeof queryString === 'string', 'Query must be of type string');\n\n\t\t\t// For each tool use, get a fresh vector store client.\n\t\t\t// We don't pass in a filter here only later in the similaritySearchVectorWithScore\n\t\t\t// method to avoid an exception with some vector stores like Supabase or Pinecone(#AI-740)\n\t\t\tconst vectorStore = await args.getVectorStoreClient(\n\t\t\t\tcontext,\n\t\t\t\tundefined,\n\t\t\t\tembeddings,\n\t\t\t\titemIndex,\n\t\t\t);\n\n\t\t\ttry {\n\t\t\t\t// Embed the input query\n\t\t\t\tconst embeddedPrompt = await embeddings.embedQuery(queryString);\n\n\t\t\t\t// Search for similar documents\n\t\t\t\tlet documents = await vectorStore.similaritySearchVectorWithScore(\n\t\t\t\t\tembeddedPrompt,\n\t\t\t\t\ttopK,\n\t\t\t\t\tfilter,\n\t\t\t\t);\n\n\t\t\t\t// If reranker is used, rerank the documents\n\t\t\t\tif (useReranker && documents.length > 0) {\n\t\t\t\t\tconst reranker = (await context.getInputConnectionData(\n\t\t\t\t\t\tNodeConnectionTypes.AiReranker,\n\t\t\t\t\t\t0,\n\t\t\t\t\t)) as BaseDocumentCompressor;\n\n\t\t\t\t\tconst docs = documents.map(([doc]) => doc);\n\t\t\t\t\tconst rerankedDocuments = await reranker.compressDocuments(docs, queryString);\n\t\t\t\t\tdocuments = rerankedDocuments.map((doc) => {\n\t\t\t\t\t\tconst { relevanceScore, ...metadata } = doc.metadata;\n\t\t\t\t\t\treturn [{ ...doc, metadata }, relevanceScore];\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Format the documents for the tool output\n\t\t\t\treturn documents\n\t\t\t\t\t.map((document) => {\n\t\t\t\t\t\tif (includeDocumentMetadata) {\n\t\t\t\t\t\t\treturn { type: 'text', text: JSON.stringify(document[0]) };\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\ttype: 'text',\n\t\t\t\t\t\t\ttext: JSON.stringify({ pageContent: document[0].pageContent }),\n\t\t\t\t\t\t};\n\t\t\t\t\t})\n\t\t\t\t\t.filter((document) => !!document);\n\t\t\t} finally {\n\t\t\t\t// Release the vector store client if a release method was provided\n\t\t\t\targs.releaseVectorStoreClient?.(vectorStore);\n\t\t\t}\n\t\t},\n\t});\n\n\t// Return the vector store tool with logging wrapper\n\treturn {\n\t\tresponse: logWrapper(vectorStoreTool, context),\n\t};\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA,+BAAmC;AACnC,qBAAyC;AACzC,wBAA2B;AAE3B,0BAAgE;AAQhE,eAAsB,8BACrB,SACA,MACA,YACA,WACsB;AAEtB,QAAM,kBAAkB,QAAQ,iBAAiB,mBAAmB,SAAS;AAE7E,QAAM,OAAO,QAAQ,QAAQ;AAC7B,QAAM,EAAE,YAAY,IAAI;AACxB,QAAM,WACL,cAAc,MACV,QAAQ,iBAAiB,YAAY,SAAS,QAC/C,wCAAmB,IAAI;AAG3B,QAAM,sBAAkB,6CAAmB,MAAM;AAAA,IAChD,MAAM;AAAA,IACN,aAAa;AAAA,IACb,WAAW,CAAC,EAAE,KAAK,SAAS,aAAa,gCAAgC,CAAC;AAAA,IAC1E,MAAM,OAAO,UAAU;AACtB,YAAM,OAAO,QAAQ,iBAAiB,QAAQ,WAAW,CAAC;AAC1D,YAAM,cAAc,QAAQ,iBAAiB,eAAe,WAAW,KAAK;AAC5E,YAAM,0BAA0B,QAAQ;AAAA,QACvC;AAAA,QACA;AAAA,QACA;AAAA,MACD;AAGA,YAAM,aAAS,yCAAyB,SAAS,SAAS;AAG1D,YAAM,cAAc,OAAO,UAAU,WAAW,QAAQ,MAAM;AAC9D,sCAAO,OAAO,gBAAgB,UAAU,8BAA8B;AAKtE,YAAM,cAAc,MAAM,KAAK;AAAA,QAC9B;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACD;AAEA,UAAI;AAEH,cAAM,iBAAiB,MAAM,WAAW,WAAW,WAAW;AAG9D,YAAI,YAAY,MAAM,YAAY;AAAA,UACjC;AAAA,UACA;AAAA,UACA;AAAA,QACD;AAGA,YAAI,eAAe,UAAU,SAAS,GAAG;AACxC,gBAAM,WAAY,MAAM,QAAQ;AAAA,YAC/B,wCAAoB;AAAA,YACpB;AAAA,UACD;AAEA,gBAAM,OAAO,UAAU,IAAI,CAAC,CAAC,GAAG,MAAM,GAAG;AACzC,gBAAM,oBAAoB,MAAM,SAAS,kBAAkB,MAAM,WAAW;AAC5E,sBAAY,kBAAkB,IAAI,CAAC,QAAQ;AAC1C,kBAAM,EAAE,gBAAgB,GAAG,SAAS,IAAI,IAAI;AAC5C,mBAAO,CAAC,EAAE,GAAG,KAAK,SAAS,GAAG,cAAc;AAAA,UAC7C,CAAC;AAAA,QACF;AAGA,eAAO,UACL,IAAI,CAAC,aAAa;AAClB,cAAI,yBAAyB;AAC5B,mBAAO,EAAE,MAAM,QAAQ,MAAM,KAAK,UAAU,SAAS,CAAC,CAAC,EAAE;AAAA,UAC1D;AACA,iBAAO;AAAA,YACN,MAAM;AAAA,YACN,MAAM,KAAK,UAAU,EAAE,aAAa,SAAS,CAAC,EAAE,YAAY,CAAC;AAAA,UAC9D;AAAA,QACD,CAAC,EACA,OAAO,CAAC,aAAa,CAAC,CAAC,QAAQ;AAAA,MAClC,UAAE;AAED,aAAK,2BAA2B,WAAW;AAAA,MAC5C;AAAA,IACD;AAAA,EACD,CAAC;AAGD,SAAO;AAAA,IACN,cAAU,8BAAW,iBAAiB,OAAO;AAAA,EAC9C;AACD;","names":[]}
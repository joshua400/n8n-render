{"version":3,"sources":["../../utils/fromAIToolFactory.ts"],"sourcesContent":["import type { CallbackManagerForToolRun } from '@langchain/core/callbacks/manager';\nimport { DynamicStructuredTool, DynamicTool } from '@langchain/core/tools';\nimport type { FromAIArgument, IDataObject, INode, INodeParameters } from 'n8n-workflow';\nimport { generateZodSchema, traverseNodeParameters } from 'n8n-workflow';\nimport { z } from 'zod';\n\nexport type ToolFunc = (\n\tquery: string | IDataObject,\n\trunManager?: CallbackManagerForToolRun,\n) => Promise<string | IDataObject | IDataObject[]>;\n\nexport interface CreateToolOptions {\n\tname: string;\n\tdescription: string;\n\tfunc: ToolFunc;\n\t/**\n\t * Extra arguments to include in the structured tool schema.\n\t * These are added after extracting $fromAI parameters from node parameters.\n\t */\n\textraArgs?: FromAIArgument[];\n}\n\n/**\n * Extracts $fromAI parameters from node parameters and returns unique arguments.\n */\nexport function extractFromAIParameters(nodeParameters: INodeParameters): FromAIArgument[] {\n\tconst collectedArguments: FromAIArgument[] = [];\n\ttraverseNodeParameters(nodeParameters, collectedArguments);\n\n\tconst uniqueArgsMap = new Map<string, FromAIArgument>();\n\tfor (const arg of collectedArguments) {\n\t\tuniqueArgsMap.set(arg.key, arg);\n\t}\n\n\treturn Array.from(uniqueArgsMap.values());\n}\n\n/**\n * Creates a Zod schema from $fromAI arguments.\n */\nexport function createZodSchemaFromArgs(args: FromAIArgument[]): z.ZodObject<z.ZodRawShape> {\n\tconst schemaObj = args.reduce((acc: Record<string, z.ZodTypeAny>, placeholder) => {\n\t\tacc[placeholder.key] = generateZodSchema(placeholder);\n\t\treturn acc;\n\t}, {});\n\n\treturn z.object(schemaObj).required();\n}\n\n/**\n * Creates a DynamicStructuredTool if node has $fromAI parameters,\n * otherwise falls back to a simple DynamicTool.\n *\n * This is useful for creating AI agent tools that can extract parameters\n * from node configuration using $fromAI expressions.\n */\nexport function createToolFromNode(\n\tnode: INode,\n\toptions: CreateToolOptions,\n): DynamicStructuredTool | DynamicTool {\n\tconst { name, description, func, extraArgs = [] } = options;\n\n\tconst collectedArguments = extractFromAIParameters(node.parameters);\n\n\t// If there are no $fromAI arguments and no extra args, fallback to simple tool\n\tif (collectedArguments.length === 0 && extraArgs.length === 0) {\n\t\treturn new DynamicTool({ name, description, func });\n\t}\n\n\t// Combine collected arguments with extra arguments\n\tconst allArguments = [...collectedArguments, ...extraArgs];\n\tconst schema = createZodSchemaFromArgs(allArguments);\n\n\treturn new DynamicStructuredTool({ schema, name, description, func });\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,mBAAmD;AAEnD,0BAA0D;AAC1D,iBAAkB;AAqBX,SAAS,wBAAwB,gBAAmD;AAC1F,QAAM,qBAAuC,CAAC;AAC9C,kDAAuB,gBAAgB,kBAAkB;AAEzD,QAAM,gBAAgB,oBAAI,IAA4B;AACtD,aAAW,OAAO,oBAAoB;AACrC,kBAAc,IAAI,IAAI,KAAK,GAAG;AAAA,EAC/B;AAEA,SAAO,MAAM,KAAK,cAAc,OAAO,CAAC;AACzC;AAKO,SAAS,wBAAwB,MAAoD;AAC3F,QAAM,YAAY,KAAK,OAAO,CAAC,KAAmC,gBAAgB;AACjF,QAAI,YAAY,GAAG,QAAI,uCAAkB,WAAW;AACpD,WAAO;AAAA,EACR,GAAG,CAAC,CAAC;AAEL,SAAO,aAAE,OAAO,SAAS,EAAE,SAAS;AACrC;AASO,SAAS,mBACf,MACA,SACsC;AACtC,QAAM,EAAE,MAAM,aAAa,MAAM,YAAY,CAAC,EAAE,IAAI;AAEpD,QAAM,qBAAqB,wBAAwB,KAAK,UAAU;AAGlE,MAAI,mBAAmB,WAAW,KAAK,UAAU,WAAW,GAAG;AAC9D,WAAO,IAAI,yBAAY,EAAE,MAAM,aAAa,KAAK,CAAC;AAAA,EACnD;AAGA,QAAM,eAAe,CAAC,GAAG,oBAAoB,GAAG,SAAS;AACzD,QAAM,SAAS,wBAAwB,YAAY;AAEnD,SAAO,IAAI,mCAAsB,EAAE,QAAQ,MAAM,aAAa,KAAK,CAAC;AACrE;","names":[]}
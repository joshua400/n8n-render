{"version":3,"sources":["../../../utils/agent-execution/memoryManagement.ts"],"sourcesContent":["import type { BaseChatModel } from '@langchain/core/language_models/chat_models';\nimport type { BaseMessage } from '@langchain/core/messages';\nimport { trimMessages } from '@langchain/core/messages';\nimport type { BaseChatMemory } from '@langchain/classic/memory';\n\nimport type { ToolCallData } from './types';\n\n/**\n * Builds a formatted string representation of tool calls for memory storage.\n * This creates a consistent format that can be used across both streaming and non-streaming modes.\n *\n * @param steps - Array of tool call data with actions and observations\n * @returns Formatted string of tool calls separated by semicolons\n *\n * @example\n * ```typescript\n * const context = buildToolContext([{\n *   action: { tool: 'calculator', toolInput: { expression: '2+2' }, ... },\n *   observation: '4'\n * }]);\n * // Returns: \"Tool: calculator, Input: {\"expression\":\"2+2\"}, Result: 4\"\n * ```\n */\nexport function buildToolContext(steps: ToolCallData[]): string {\n\treturn steps\n\t\t.map(\n\t\t\t(step) =>\n\t\t\t\t`Tool: ${step.action.tool}, Input: ${JSON.stringify(step.action.toolInput)}, Result: ${step.observation}`,\n\t\t)\n\t\t.join('; ');\n}\n\n/**\n * Loads chat history from memory and optionally trims it to fit within token limits.\n *\n * @param memory - The memory instance to load from\n * @param model - Optional chat model for token counting (required if maxTokens is specified)\n * @param maxTokens - Optional maximum number of tokens to load from memory\n * @returns Array of base messages representing the chat history\n *\n * @example\n * ```typescript\n * // Load all history\n * const messages = await loadMemory(memory);\n *\n * // Load with token limit\n * const messages = await loadMemory(memory, model, 2000);\n * ```\n */\nexport async function loadMemory(\n\tmemory?: BaseChatMemory,\n\tmodel?: BaseChatModel,\n\tmaxTokens?: number,\n): Promise<BaseMessage[] | undefined> {\n\tif (!memory) {\n\t\treturn undefined;\n\t}\n\tconst memoryVariables = await memory.loadMemoryVariables({});\n\tlet chatHistory = (memoryVariables['chat_history'] as BaseMessage[]) || [];\n\n\t// Trim messages if token limit is specified and model is available\n\tif (maxTokens && model) {\n\t\tchatHistory = await trimMessages(chatHistory, {\n\t\t\tstrategy: 'last',\n\t\t\tmaxTokens,\n\t\t\ttokenCounter: model,\n\t\t\tincludeSystem: true,\n\t\t\tstartOn: 'human',\n\t\t\tallowPartial: true,\n\t\t});\n\t}\n\n\treturn chatHistory;\n}\n\n/**\n * Saves a conversation turn (user input + agent output) to memory.\n *\n * @param memory - The memory instance to save to\n * @param input - The user input/prompt\n * @param output - The agent's output/response\n *\n * @example\n * ```typescript\n * await saveToMemory(memory, 'What is 2+2?', 'The answer is 4');\n * ```\n */\nexport async function saveToMemory(\n\tinput: string,\n\toutput: string,\n\tmemory?: BaseChatMemory,\n\tsteps?: ToolCallData[],\n): Promise<void> {\n\tif (!output || !memory) {\n\t\treturn;\n\t}\n\tlet fullOutput = output;\n\tif (steps && steps.length > 0) {\n\t\tconst toolContext = buildToolContext(steps);\n\t\tfullOutput = `[Used tools: ${toolContext}] ${fullOutput}`;\n\t}\n\n\tawait memory.saveContext({ input }, { output: fullOutput });\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,sBAA6B;AAqBtB,SAAS,iBAAiB,OAA+B;AAC/D,SAAO,MACL;AAAA,IACA,CAAC,SACA,SAAS,KAAK,OAAO,IAAI,YAAY,KAAK,UAAU,KAAK,OAAO,SAAS,CAAC,aAAa,KAAK,WAAW;AAAA,EACzG,EACC,KAAK,IAAI;AACZ;AAmBA,eAAsB,WACrB,QACA,OACA,WACqC;AACrC,MAAI,CAAC,QAAQ;AACZ,WAAO;AAAA,EACR;AACA,QAAM,kBAAkB,MAAM,OAAO,oBAAoB,CAAC,CAAC;AAC3D,MAAI,cAAe,gBAAgB,cAAc,KAAuB,CAAC;AAGzE,MAAI,aAAa,OAAO;AACvB,kBAAc,UAAM,8BAAa,aAAa;AAAA,MAC7C,UAAU;AAAA,MACV;AAAA,MACA,cAAc;AAAA,MACd,eAAe;AAAA,MACf,SAAS;AAAA,MACT,cAAc;AAAA,IACf,CAAC;AAAA,EACF;AAEA,SAAO;AACR;AAcA,eAAsB,aACrB,OACA,QACA,QACA,OACgB;AAChB,MAAI,CAAC,UAAU,CAAC,QAAQ;AACvB;AAAA,EACD;AACA,MAAI,aAAa;AACjB,MAAI,SAAS,MAAM,SAAS,GAAG;AAC9B,UAAM,cAAc,iBAAiB,KAAK;AAC1C,iBAAa,gBAAgB,WAAW,KAAK,UAAU;AAAA,EACxD;AAEA,QAAM,OAAO,YAAY,EAAE,MAAM,GAAG,EAAE,QAAQ,WAAW,CAAC;AAC3D;","names":[]}
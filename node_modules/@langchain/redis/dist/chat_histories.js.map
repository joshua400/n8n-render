{"version":3,"file":"chat_histories.js","names":["fields: RedisChatMessageHistoryInput","message: BaseMessage"],"sources":["../src/chat_histories.ts"],"sourcesContent":["import {\n  RedisClientOptions,\n  RedisClientType,\n  RedisModules,\n  RedisFunctions,\n  RedisScripts,\n} from \"redis\";\nimport { BaseListChatMessageHistory } from \"@langchain/core/chat_history\";\nimport {\n  BaseMessage,\n  mapChatMessagesToStoredMessages,\n  mapStoredMessagesToChatMessages,\n} from \"@langchain/core/messages\";\nimport { pool } from \"./connections.js\";\n\n/**\n * Type for the input to the `RedisChatMessageHistory` constructor.\n */\nexport type RedisChatMessageHistoryInput = {\n  sessionId: string;\n  sessionTTL?: number;\n  config?: RedisClientOptions;\n  // Typing issues with createClient output: https://github.com/redis/node-redis/issues/1865\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  client?: any;\n};\n\n/**\n * Class for storing chat message history using Redis. Extends the\n * `BaseListChatMessageHistory` class.\n * @example\n * ```typescript\n * const chatHistory = new RedisChatMessageHistory({\n *   sessionId: new Date().toISOString(),\n *   sessionTTL: 300,\n *   url: \"redis:\n * });\n *\n * const chain = new ConversationChain({\n *   llm: new ChatOpenAI({ model: \"gpt-3.5-turbo\", temperature: 0 }),\n *   memory: { chatHistory },\n * });\n *\n * const response = await chain.invoke({\n *   input: \"What did I just say my name was?\",\n * });\n * console.log({ response });\n * ```\n */\nexport class RedisChatMessageHistory extends BaseListChatMessageHistory {\n  lc_namespace = [\"langchain\", \"stores\", \"message\", \"redis\"];\n\n  get lc_secrets() {\n    return {\n      \"config.url\": \"REDIS_URL\",\n      \"config.username\": \"REDIS_USERNAME\",\n      \"config.password\": \"REDIS_PASSWORD\",\n    };\n  }\n\n  public client: RedisClientType<RedisModules, RedisFunctions, RedisScripts>;\n\n  private sessionId: string;\n\n  private sessionTTL?: number;\n\n  constructor(fields: RedisChatMessageHistoryInput) {\n    super(fields);\n\n    const { sessionId, sessionTTL, config, client } = fields;\n    this.client = (client ?? pool.getClient(config)) as RedisClientType<\n      RedisModules,\n      RedisFunctions,\n      RedisScripts\n    >;\n    this.sessionId = sessionId;\n    this.sessionTTL = sessionTTL;\n  }\n\n  /**\n   * Ensures the Redis client is ready to perform operations. If the client\n   * is not ready, it attempts to connect to the Redis database.\n   * @returns Promise resolving to true when the client is ready.\n   */\n  async ensureReadiness() {\n    if (!this.client.isReady) {\n      await this.client.connect();\n    }\n    return true;\n  }\n\n  /**\n   * Retrieves all chat messages from the Redis database for the current\n   * session.\n   * @returns Promise resolving to an array of `BaseMessage` instances.\n   */\n  async getMessages(): Promise<BaseMessage[]> {\n    await this.ensureReadiness();\n    const rawStoredMessages = await this.client.lRange(this.sessionId, 0, -1);\n    const orderedMessages = rawStoredMessages\n      .reverse()\n      .map((message) => JSON.parse(message));\n    return mapStoredMessagesToChatMessages(orderedMessages);\n  }\n\n  /**\n   * Adds a new chat message to the Redis database for the current session.\n   * @param message The `BaseMessage` instance to add.\n   * @returns Promise resolving when the message has been added.\n   */\n  async addMessage(message: BaseMessage): Promise<void> {\n    await this.ensureReadiness();\n    const messageToAdd = mapChatMessagesToStoredMessages([message]);\n    await this.client.lPush(this.sessionId, JSON.stringify(messageToAdd[0]));\n    if (this.sessionTTL) {\n      await this.client.expire(this.sessionId, this.sessionTTL);\n    }\n  }\n\n  /**\n   * Deletes all chat messages from the Redis database for the current\n   * session.\n   * @returns Promise resolving when the messages have been deleted.\n   */\n  async clear(): Promise<void> {\n    await this.ensureReadiness();\n    await this.client.del(this.sessionId);\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAiDA,IAAa,0BAAb,cAA6C,2BAA2B;CACtE,eAAe;EAAC;EAAa;EAAU;EAAW;CAAQ;CAE1D,IAAI,aAAa;AACf,SAAO;GACL,cAAc;GACd,mBAAmB;GACnB,mBAAmB;EACpB;CACF;CAED,AAAO;CAEP,AAAQ;CAER,AAAQ;CAER,YAAYA,QAAsC;EAChD,MAAM,OAAO;EAEb,MAAM,EAAE,WAAW,YAAY,QAAQ,QAAQ,GAAG;EAClD,KAAK,SAAU,UAAU,KAAK,UAAU,OAAO;EAK/C,KAAK,YAAY;EACjB,KAAK,aAAa;CACnB;;;;;;CAOD,MAAM,kBAAkB;AACtB,MAAI,CAAC,KAAK,OAAO,SACf,MAAM,KAAK,OAAO,SAAS;AAE7B,SAAO;CACR;;;;;;CAOD,MAAM,cAAsC;EAC1C,MAAM,KAAK,iBAAiB;EAC5B,MAAM,oBAAoB,MAAM,KAAK,OAAO,OAAO,KAAK,WAAW,GAAG,GAAG;EACzE,MAAM,kBAAkB,kBACrB,SAAS,CACT,IAAI,CAAC,YAAY,KAAK,MAAM,QAAQ,CAAC;AACxC,SAAO,gCAAgC,gBAAgB;CACxD;;;;;;CAOD,MAAM,WAAWC,SAAqC;EACpD,MAAM,KAAK,iBAAiB;EAC5B,MAAM,eAAe,gCAAgC,CAAC,OAAQ,EAAC;EAC/D,MAAM,KAAK,OAAO,MAAM,KAAK,WAAW,KAAK,UAAU,aAAa,GAAG,CAAC;AACxE,MAAI,KAAK,YACP,MAAM,KAAK,OAAO,OAAO,KAAK,WAAW,KAAK,WAAW;CAE5D;;;;;;CAOD,MAAM,QAAuB;EAC3B,MAAM,KAAK,iBAAiB;EAC5B,MAAM,KAAK,OAAO,IAAI,KAAK,UAAU;CACtC;AACF"}
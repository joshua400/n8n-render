{"version":3,"file":"auth.js","names":["res: Response","opts: GoogleAbstractedClientOps","url: string | undefined","additionalHeaders: Record<string, string>","fetchOptions: {\n      method?: string;\n      headers: Record<string, string>;\n      body?: string;\n    }","apiKey: string","platform: GooglePlatformType","authOption: AuthOptions | undefined","scopeProperty: string","scopesOrPlatform: string[] | GooglePlatformType | undefined","scopes: string[]"],"sources":["../src/auth.ts"],"sourcesContent":["import { ReadableJsonStream } from \"./utils/stream.js\";\nimport { GooglePlatformType } from \"./types.js\";\n\nexport type GoogleAbstractedClientOpsMethod = \"GET\" | \"POST\" | \"DELETE\";\n\nexport type GoogleAbstractedClientOpsResponseType = \"json\" | \"stream\" | \"blob\";\n\nexport type GoogleAbstractedClientOps = {\n  url?: string;\n  method?: GoogleAbstractedClientOpsMethod;\n  headers?: Record<string, string>;\n  data?: unknown;\n  responseType?: GoogleAbstractedClientOpsResponseType;\n};\n\nexport interface GoogleAbstractedClient {\n  request: (opts: GoogleAbstractedClientOps) => unknown;\n  getProjectId: () => Promise<string>;\n  get clientType(): string;\n}\n\nexport abstract class GoogleAbstractedFetchClient\n  implements GoogleAbstractedClient\n{\n  abstract get clientType(): string;\n\n  abstract getProjectId(): Promise<string>;\n\n  abstract request(opts: GoogleAbstractedClientOps): unknown;\n\n  _fetch: typeof fetch = fetch;\n\n  async _buildData(res: Response, opts: GoogleAbstractedClientOps) {\n    switch (opts.responseType) {\n      case \"json\":\n        return res.json();\n      case \"stream\":\n        return new ReadableJsonStream(res.body);\n      default:\n        return res.blob();\n    }\n  }\n\n  async _request(\n    url: string | undefined,\n    opts: GoogleAbstractedClientOps,\n    additionalHeaders: Record<string, string>\n  ) {\n    if (url == null) throw new Error(\"Missing URL\");\n    const fetchOptions: {\n      method?: string;\n      headers: Record<string, string>;\n      body?: string;\n    } = {\n      method: opts.method,\n      headers: {\n        \"Content-Type\": \"application/json\",\n        ...(opts.headers ?? {}),\n        ...(additionalHeaders ?? {}),\n      },\n    };\n    if (opts.data !== undefined) {\n      if (typeof opts.data === \"string\") {\n        fetchOptions.body = opts.data;\n      } else {\n        fetchOptions.body = JSON.stringify(opts.data);\n      }\n    }\n\n    const res = await this._fetch(url, fetchOptions);\n\n    if (!res.ok) {\n      const resText = await res.text();\n      const error = new Error(\n        `Google request failed with status code ${res.status}: ${resText}`\n      );\n      /* eslint-disable @typescript-eslint/no-explicit-any */\n      (error as any).response = res;\n      (error as any).details = {\n        url,\n        opts,\n        fetchOptions,\n        result: res,\n      };\n      /* eslint-enable @typescript-eslint/no-explicit-any */\n      throw error;\n    }\n\n    const data = await this._buildData(res, opts);\n    return {\n      data,\n      config: {},\n      status: res.status,\n      statusText: res.statusText,\n      headers: res.headers,\n      request: { responseURL: res.url },\n    };\n  }\n}\n\nexport class ApiKeyGoogleAuth extends GoogleAbstractedFetchClient {\n  apiKey: string;\n\n  constructor(apiKey: string) {\n    super();\n    this.apiKey = apiKey;\n  }\n\n  get clientType(): string {\n    return \"apiKey\";\n  }\n\n  getProjectId(): Promise<string> {\n    throw new Error(\"APIs that require a project ID cannot use an API key\");\n    // Perhaps we could implement this if needed:\n    // https://cloud.google.com/docs/authentication/api-keys#get-info\n  }\n\n  request(opts: GoogleAbstractedClientOps): unknown {\n    const authHeader = {\n      \"X-Goog-Api-Key\": this.apiKey,\n    };\n    return this._request(opts.url, opts, authHeader);\n  }\n}\n\nexport function aiPlatformScope(platform: GooglePlatformType): string[] {\n  switch (platform) {\n    case \"gai\":\n      return [\"https://www.googleapis.com/auth/generative-language\"];\n    default:\n      return [\"https://www.googleapis.com/auth/cloud-platform\"];\n  }\n}\n\nexport function ensureAuthOptionScopes<AuthOptions>(\n  authOption: AuthOptions | undefined,\n  scopeProperty: string,\n  scopesOrPlatform: string[] | GooglePlatformType | undefined\n): AuthOptions {\n  // If the property is already set, return it\n  if (authOption && Object.hasOwn(authOption, scopeProperty)) {\n    return authOption;\n  }\n\n  // Otherwise add it\n  const scopes: string[] = Array.isArray(scopesOrPlatform)\n    ? (scopesOrPlatform as string[])\n    : aiPlatformScope(scopesOrPlatform ?? \"gcp\");\n  return {\n    [scopeProperty]: scopes,\n    ...(authOption ?? {}),\n  } as AuthOptions;\n}\n"],"mappings":";;;AAqBA,IAAsB,8BAAtB,MAEA;CAOE,SAAuB;CAEvB,MAAM,WAAWA,KAAeC,MAAiC;AAC/D,UAAQ,KAAK,cAAb;GACE,KAAK,OACH,QAAO,IAAI,MAAM;GACnB,KAAK,SACH,QAAO,IAAI,mBAAmB,IAAI;GACpC,QACE,QAAO,IAAI,MAAM;EACpB;CACF;CAED,MAAM,SACJC,KACAD,MACAE,mBACA;AACA,MAAI,OAAO,KAAM,OAAM,IAAI,MAAM;EACjC,MAAMC,eAIF;GACF,QAAQ,KAAK;GACb,SAAS;IACP,gBAAgB;IAChB,GAAI,KAAK,WAAW,CAAE;IACtB,GAAI,qBAAqB,CAAE;GAC5B;EACF;AACD,MAAI,KAAK,SAAS,OAChB,KAAI,OAAO,KAAK,SAAS,UACvB,aAAa,OAAO,KAAK;OAEzB,aAAa,OAAO,KAAK,UAAU,KAAK,KAAK;EAIjD,MAAM,MAAM,MAAM,KAAK,OAAO,KAAK,aAAa;AAEhD,MAAI,CAAC,IAAI,IAAI;GACX,MAAM,UAAU,MAAM,IAAI,MAAM;GAChC,MAAM,wBAAQ,IAAI,MAChB,CAAC,uCAAuC,EAAE,IAAI,OAAO,EAAE,EAAE,SAAS;GAGnE,MAAc,WAAW;GACzB,MAAc,UAAU;IACvB;IACA;IACA;IACA,QAAQ;GACT;AAED,SAAM;EACP;EAED,MAAM,OAAO,MAAM,KAAK,WAAW,KAAK,KAAK;AAC7C,SAAO;GACL;GACA,QAAQ,CAAE;GACV,QAAQ,IAAI;GACZ,YAAY,IAAI;GAChB,SAAS,IAAI;GACb,SAAS,EAAE,aAAa,IAAI,IAAK;EAClC;CACF;AACF;AAED,IAAa,mBAAb,cAAsC,4BAA4B;CAChE;CAEA,YAAYC,QAAgB;EAC1B,OAAO;EACP,KAAK,SAAS;CACf;CAED,IAAI,aAAqB;AACvB,SAAO;CACR;CAED,eAAgC;AAC9B,QAAM,IAAI,MAAM;CAGjB;CAED,QAAQJ,MAA0C;EAChD,MAAM,aAAa,EACjB,kBAAkB,KAAK,OACxB;AACD,SAAO,KAAK,SAAS,KAAK,KAAK,MAAM,WAAW;CACjD;AACF;AAED,SAAgB,gBAAgBK,UAAwC;AACtE,SAAQ,UAAR;EACE,KAAK,MACH,QAAO,CAAC,qDAAsD;EAChE,QACE,QAAO,CAAC,gDAAiD;CAC5D;AACF;AAED,SAAgB,uBACdC,YACAC,eACAC,kBACa;AAEb,KAAI,cAAc,OAAO,OAAO,YAAY,cAAc,CACxD,QAAO;CAIT,MAAMC,SAAmB,MAAM,QAAQ,iBAAiB,GACnD,mBACD,gBAAgB,oBAAoB,MAAM;AAC9C,QAAO;GACJ,gBAAgB;EACjB,GAAI,cAAc,CAAE;CACrB;AACF"}
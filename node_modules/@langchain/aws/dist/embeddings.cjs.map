{"version":3,"file":"embeddings.cjs","names":["Embeddings","fields?: BedrockEmbeddingsParams","BedrockRuntimeClient","text: string","InvokeModelCommand","document: string","documents: string[]"],"sources":["../src/embeddings.ts"],"sourcesContent":["import {\n  BedrockRuntimeClient,\n  BedrockRuntimeClientConfig,\n  InvokeModelCommand,\n} from \"@aws-sdk/client-bedrock-runtime\";\nimport { Embeddings, EmbeddingsParams } from \"@langchain/core/embeddings\";\nimport { CredentialType } from \"./types.js\";\n\n/**\n * Interface that extends EmbeddingsParams and defines additional\n * parameters specific to the BedrockEmbeddings class.\n */\nexport interface BedrockEmbeddingsParams extends EmbeddingsParams {\n  /**\n   * Model Name to use. Defaults to `amazon.titan-embed-text-v1` if not provided\n   *\n   */\n  model?: string;\n\n  /**\n   * A client provided by the user that allows them to customze any\n   * SDK configuration options.\n   */\n  client?: BedrockRuntimeClient;\n\n  /**\n   * Overrideable configuration options for the BedrockRuntimeClient.\n   * Allows customization of client configuration such as requestHandler, etc.\n   * Will be ignored if 'client' is provided.\n   */\n  clientOptions?: BedrockRuntimeClientConfig;\n\n  region?: string;\n\n  credentials?: CredentialType;\n}\n\n/**\n * Class that extends the Embeddings class and provides methods for\n * generating embeddings using the Bedrock API.\n * @example\n * ```typescript\n * const embeddings = new BedrockEmbeddings({\n *   region: \"your-aws-region\",\n *   credentials: {\n *     accessKeyId: \"your-access-key-id\",\n *     secretAccessKey: \"your-secret-access-key\",\n *   },\n *   model: \"amazon.titan-embed-text-v1\",\n *   // Configure client options (e.g., custom request handler)\n *   // clientOptions: {\n *   //   requestHandler: myCustomRequestHandler,\n *   // },\n * });\n *\n * // Embed a query and log the result\n * const res = await embeddings.embedQuery(\n *   \"What would be a good company name for a company that makes colorful socks?\"\n * );\n * console.log({ res });\n * ```\n */\nexport class BedrockEmbeddings\n  extends Embeddings\n  implements BedrockEmbeddingsParams\n{\n  model: string;\n\n  client: BedrockRuntimeClient;\n\n  clientOptions?: BedrockRuntimeClientConfig;\n\n  batchSize = 512;\n\n  constructor(fields?: BedrockEmbeddingsParams) {\n    super(fields ?? {});\n\n    this.model = fields?.model ?? \"amazon.titan-embed-text-v1\";\n    this.clientOptions = fields?.clientOptions;\n\n    this.client =\n      fields?.client ??\n      new BedrockRuntimeClient({\n        ...fields?.clientOptions,\n        region: fields?.region,\n        credentials: fields?.credentials,\n      });\n  }\n\n  /**\n   * Protected method to make a request to the Bedrock API to generate\n   * embeddings. Handles the retry logic and returns the response from the\n   * API.\n   * @param request Request to send to the Bedrock API.\n   * @returns Promise that resolves to the response from the API.\n   */\n  protected async _embedText(text: string): Promise<number[]> {\n    return this.caller.call(async () => {\n      try {\n        // replace newlines, which can negatively affect performance.\n        const cleanedText = text.replace(/\\n/g, \" \");\n\n        const res = await this.client.send(\n          new InvokeModelCommand({\n            modelId: this.model,\n            body: JSON.stringify({\n              inputText: cleanedText,\n            }),\n            contentType: \"application/json\",\n            accept: \"application/json\",\n          })\n        );\n\n        const body = new TextDecoder().decode(res.body);\n        return JSON.parse(body).embedding;\n      } catch (e) {\n        console.error({\n          error: e,\n        });\n        // eslint-disable-next-line no-instanceof/no-instanceof\n        if (e instanceof Error) {\n          throw new Error(\n            `An error occurred while embedding documents with Bedrock: ${e.message}`\n          );\n        }\n\n        throw new Error(\n          \"An error occurred while embedding documents with Bedrock\"\n        );\n      }\n    });\n  }\n\n  /**\n   * Method that takes a document as input and returns a promise that\n   * resolves to an embedding for the document. It calls the _embedText\n   * method with the document as the input.\n   * @param document Document for which to generate an embedding.\n   * @returns Promise that resolves to an embedding for the input document.\n   */\n  embedQuery(document: string): Promise<number[]> {\n    return this.caller.callWithOptions(\n      {},\n      this._embedText.bind(this),\n      document\n    );\n  }\n\n  /**\n   * Method to generate embeddings for an array of texts. Calls _embedText\n   * method which batches and handles retry logic when calling the AWS Bedrock API.\n   * @param documents Array of texts for which to generate embeddings.\n   * @returns Promise that resolves to a 2D array of embeddings for each input document.\n   */\n  async embedDocuments(documents: string[]): Promise<number[][]> {\n    return Promise.all(documents.map((document) => this._embedText(document)));\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8DA,IAAa,oBAAb,cACUA,uCAEV;CACE;CAEA;CAEA;CAEA,YAAY;CAEZ,YAAYC,QAAkC;EAC5C,MAAM,UAAU,CAAE,EAAC;EAEnB,KAAK,QAAQ,QAAQ,SAAS;EAC9B,KAAK,gBAAgB,QAAQ;EAE7B,KAAK,SACH,QAAQ,UACR,IAAIC,sDAAqB;GACvB,GAAG,QAAQ;GACX,QAAQ,QAAQ;GAChB,aAAa,QAAQ;EACtB;CACJ;;;;;;;;CASD,MAAgB,WAAWC,MAAiC;AAC1D,SAAO,KAAK,OAAO,KAAK,YAAY;AAClC,OAAI;IAEF,MAAM,cAAc,KAAK,QAAQ,OAAO,IAAI;IAE5C,MAAM,MAAM,MAAM,KAAK,OAAO,KAC5B,IAAIC,oDAAmB;KACrB,SAAS,KAAK;KACd,MAAM,KAAK,UAAU,EACnB,WAAW,YACZ,EAAC;KACF,aAAa;KACb,QAAQ;IACT,GACF;IAED,MAAM,OAAO,IAAI,cAAc,OAAO,IAAI,KAAK;AAC/C,WAAO,KAAK,MAAM,KAAK,CAAC;GACzB,SAAQ,GAAG;IACV,QAAQ,MAAM,EACZ,OAAO,EACR,EAAC;AAEF,QAAI,aAAa,MACf,OAAM,IAAI,MACR,CAAC,0DAA0D,EAAE,EAAE,SAAS;AAI5E,UAAM,IAAI,MACR;GAEH;EACF,EAAC;CACH;;;;;;;;CASD,WAAWC,UAAqC;AAC9C,SAAO,KAAK,OAAO,gBACjB,CAAE,GACF,KAAK,WAAW,KAAK,KAAK,EAC1B,SACD;CACF;;;;;;;CAQD,MAAM,eAAeC,WAA0C;AAC7D,SAAO,QAAQ,IAAI,UAAU,IAAI,CAAC,aAAa,KAAK,WAAW,SAAS,CAAC,CAAC;CAC3E;AACF"}
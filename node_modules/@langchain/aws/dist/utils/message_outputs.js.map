{"version":3,"file":"message_outputs.js","names":["message: Bedrock.Message","responseMetadata: Omit<Bedrock.ConverseResponse, \"output\">","requestId: string | undefined","tokenUsage: UsageMetadata | undefined","toolCalls: ToolCall[]","content: ContentBlock[]","contentBlockDelta: Bedrock.ContentBlockDeltaEvent","contentBlockStart: Bedrock.ContentBlockStartEvent","metadata: Bedrock.ConverseStreamMetadataEvent","extra: {\n    streamUsage: boolean;\n  }","usage_metadata: UsageMetadata","reasoningContent: Bedrock.ReasoningContentBlockDelta","reasoningContent: Bedrock.ReasoningContentBlock"],"sources":["../../src/utils/message_outputs.ts"],"sourcesContent":["import type { ContentBlock, UsageMetadata } from \"@langchain/core/messages\";\nimport { AIMessage, AIMessageChunk } from \"@langchain/core/messages\";\nimport type { ToolCall } from \"@langchain/core/messages/tool\";\nimport type * as Bedrock from \"@aws-sdk/client-bedrock-runtime\";\nimport type { DocumentType as __DocumentType } from \"@smithy/types\";\nimport { ChatGenerationChunk } from \"@langchain/core/outputs\";\nimport {\n  MessageContentReasoningBlock,\n  MessageContentReasoningBlockReasoningTextPartial,\n  MessageContentReasoningBlockRedacted,\n} from \"../types.js\";\n\nexport function convertConverseMessageToLangChainMessage(\n  message: Bedrock.Message,\n  responseMetadata: Omit<Bedrock.ConverseResponse, \"output\">\n): AIMessage {\n  if (!message.content) {\n    throw new Error(\"No message content found in response.\");\n  }\n  if (message.role !== \"assistant\") {\n    throw new Error(\n      `Unsupported message role received in ChatBedrockConverse response: ${message.role}`\n    );\n  }\n  let requestId: string | undefined;\n  if (\n    \"$metadata\" in responseMetadata &&\n    responseMetadata.$metadata &&\n    typeof responseMetadata.$metadata === \"object\" &&\n    \"requestId\" in responseMetadata.$metadata\n  ) {\n    requestId = responseMetadata.$metadata.requestId as string;\n  }\n  let tokenUsage: UsageMetadata | undefined;\n  if (responseMetadata.usage) {\n    const input_tokens = responseMetadata.usage.inputTokens ?? 0;\n    const output_tokens = responseMetadata.usage.outputTokens ?? 0;\n    tokenUsage = {\n      input_tokens,\n      output_tokens,\n      total_tokens:\n        responseMetadata.usage.totalTokens ?? input_tokens + output_tokens,\n    };\n  }\n\n  if (\n    message.content?.length === 1 &&\n    \"text\" in message.content[0] &&\n    typeof message.content[0].text === \"string\"\n  ) {\n    return new AIMessage({\n      content: message.content[0].text,\n      response_metadata: {\n        ...responseMetadata,\n        model_provider: \"bedrock-converse\",\n      },\n      usage_metadata: tokenUsage,\n      id: requestId,\n    });\n  } else {\n    const toolCalls: ToolCall[] = [];\n    const content: ContentBlock[] = [];\n    message.content.forEach((c) => {\n      if (\"cachePoint\" in c) {\n        content.push({ type: \"cache_point\", cachePoint: c.cachePoint });\n      } else if (\"citationsContent\" in c) {\n        content.push({\n          type: \"citations_content\",\n          citationsContent: c.citationsContent,\n        });\n      } else if (\"document\" in c) {\n        content.push({ type: \"document\", document: c.document });\n      } else if (\"guardContent\" in c) {\n        content.push({ type: \"guard_content\", guardContent: c.guardContent });\n      } else if (\"image\" in c) {\n        content.push({ type: \"image\", image: c.image });\n      } else if (\"reasoningContent\" in c) {\n        content.push(\n          bedrockReasoningBlockToLangchainReasoningBlock(\n            c.reasoningContent as Bedrock.ReasoningContentBlock\n          )\n        );\n      } else if (\"text\" in c && typeof c.text === \"string\") {\n        content.push({ type: \"text\", text: c.text });\n      } else if (\"toolResult\" in c) {\n        content.push({ type: \"tool_result\", toolResult: c.toolResult });\n      } else if (\n        \"toolUse\" in c &&\n        c.toolUse &&\n        c.toolUse.name &&\n        c.toolUse.input &&\n        typeof c.toolUse.input === \"object\"\n      ) {\n        toolCalls.push({\n          id: c.toolUse.toolUseId,\n          name: c.toolUse.name,\n          args: c.toolUse.input,\n          type: \"tool_call\",\n        });\n      } else if (\"video\" in c) {\n        content.push({ type: \"video\", video: c.video });\n      }\n    });\n    return new AIMessage({\n      content: content.length ? content : \"\",\n      tool_calls: toolCalls.length ? toolCalls : undefined,\n      response_metadata: {\n        ...responseMetadata,\n        model_provider: \"bedrock-converse\",\n      },\n      usage_metadata: tokenUsage,\n      id: requestId,\n    });\n  }\n}\n\nexport function handleConverseStreamContentBlockDelta(\n  contentBlockDelta: Bedrock.ContentBlockDeltaEvent\n): ChatGenerationChunk {\n  if (!contentBlockDelta.delta) {\n    throw new Error(\"No delta found in content block.\");\n  }\n  if (typeof contentBlockDelta.delta.text === \"string\") {\n    return new ChatGenerationChunk({\n      text: contentBlockDelta.delta.text,\n      message: new AIMessageChunk({\n        content: contentBlockDelta.delta.text,\n      }),\n    });\n  } else if (contentBlockDelta.delta.toolUse) {\n    const index = contentBlockDelta.contentBlockIndex;\n    return new ChatGenerationChunk({\n      text: \"\",\n      message: new AIMessageChunk({\n        content: \"\",\n        tool_call_chunks: [\n          {\n            args: contentBlockDelta.delta.toolUse.input,\n            index,\n            type: \"tool_call_chunk\",\n          },\n        ],\n      }),\n    });\n  } else if (contentBlockDelta.delta.reasoningContent) {\n    return new ChatGenerationChunk({\n      text: \"\",\n      message: new AIMessageChunk({\n        content: [\n          bedrockReasoningDeltaToLangchainPartialReasoningBlock(\n            contentBlockDelta.delta.reasoningContent\n          ),\n        ],\n      }),\n    });\n  } else {\n    throw new Error(\n      `Unsupported content block type(s): ${JSON.stringify(\n        contentBlockDelta.delta,\n        null,\n        2\n      )}`\n    );\n  }\n}\n\nexport function handleConverseStreamContentBlockStart(\n  contentBlockStart: Bedrock.ContentBlockStartEvent\n): ChatGenerationChunk {\n  const index = contentBlockStart.contentBlockIndex;\n  if (contentBlockStart.start?.toolUse) {\n    return new ChatGenerationChunk({\n      text: \"\",\n      message: new AIMessageChunk({\n        content: \"\",\n        tool_call_chunks: [\n          {\n            name: contentBlockStart.start.toolUse.name,\n            id: contentBlockStart.start.toolUse.toolUseId,\n            index,\n            type: \"tool_call_chunk\",\n          },\n        ],\n      }),\n    });\n  }\n  throw new Error(\"Unsupported content block start event.\");\n}\n\nexport function handleConverseStreamMetadata(\n  metadata: Bedrock.ConverseStreamMetadataEvent,\n  extra: {\n    streamUsage: boolean;\n  }\n): ChatGenerationChunk {\n  const inputTokens = metadata.usage?.inputTokens ?? 0;\n  const outputTokens = metadata.usage?.outputTokens ?? 0;\n  const usage_metadata: UsageMetadata = {\n    input_tokens: inputTokens,\n    output_tokens: outputTokens,\n    total_tokens: metadata.usage?.totalTokens ?? inputTokens + outputTokens,\n  };\n  return new ChatGenerationChunk({\n    text: \"\",\n    message: new AIMessageChunk({\n      content: \"\",\n      usage_metadata: extra.streamUsage ? usage_metadata : undefined,\n      response_metadata: {\n        // Use the same key as returned from the Converse API\n        metadata,\n        model_provider: \"bedrock-converse\",\n      },\n    }),\n  });\n}\n\nexport function bedrockReasoningDeltaToLangchainPartialReasoningBlock(\n  reasoningContent: Bedrock.ReasoningContentBlockDelta\n):\n  | MessageContentReasoningBlockReasoningTextPartial\n  | MessageContentReasoningBlockRedacted {\n  const { text, redactedContent, signature } = reasoningContent;\n  if (typeof text === \"string\") {\n    return {\n      type: \"reasoning_content\",\n      reasoningText: { text },\n    };\n  }\n  if (signature) {\n    return {\n      type: \"reasoning_content\",\n      reasoningText: { signature },\n    };\n  }\n  if (redactedContent) {\n    return {\n      type: \"reasoning_content\",\n      redactedContent: Buffer.from(redactedContent).toString(\"base64\"),\n    };\n  }\n  throw new Error(\"Invalid reasoning content\");\n}\n\nexport function bedrockReasoningBlockToLangchainReasoningBlock(\n  reasoningContent: Bedrock.ReasoningContentBlock\n): MessageContentReasoningBlock {\n  const { reasoningText, redactedContent } = reasoningContent;\n  if (reasoningText) {\n    return {\n      type: \"reasoning_content\",\n      reasoningText: reasoningText as Required<Bedrock.ReasoningTextBlock>,\n    };\n  }\n\n  if (redactedContent) {\n    return {\n      type: \"reasoning_content\",\n      redactedContent: Buffer.from(redactedContent).toString(\"base64\"),\n    };\n  }\n  throw new Error(\"Invalid reasoning content\");\n}\n"],"mappings":"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"}
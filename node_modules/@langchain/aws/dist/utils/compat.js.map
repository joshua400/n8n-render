{"version":3,"file":"compat.js","names":["format: string","annotation: ContentBlock | ContentBlock.Citation","message: AIMessage"],"sources":["../../src/utils/compat.ts"],"sourcesContent":["import { AIMessage, ContentBlock } from \"@langchain/core/messages\";\nimport type * as Bedrock from \"@aws-sdk/client-bedrock-runtime\";\n\n// see `/libs/langchain-core/src/messages/block_translators/bedrock_converse.ts:convertFileFormatToMimeType`\nconst formatToMimeType = {\n  document(format: string): Bedrock.DocumentFormat {\n    switch (format) {\n      case \"text/csv\":\n        return \"csv\";\n      case \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\":\n        return \"docx\";\n      case \"text/html\":\n        return \"html\";\n      case \"text/markdown\":\n        return \"md\";\n      case \"application/pdf\":\n        return \"pdf\";\n      case \"text/plain\":\n        return \"txt\";\n      case \"application/vnd.ms-excel\":\n        return \"xls\";\n      case \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\":\n        return \"xlsx\";\n      default:\n        return format as Bedrock.DocumentFormat;\n    }\n  },\n  image(format: string): Bedrock.ImageFormat {\n    switch (format) {\n      case \"image/gif\":\n        return \"gif\";\n      case \"image/jpeg\":\n        return \"jpeg\";\n      case \"image/png\":\n        return \"png\";\n      case \"image/webp\":\n        return \"webp\";\n      default:\n        return format as Bedrock.ImageFormat;\n    }\n  },\n  video(format: string): Bedrock.VideoFormat {\n    switch (format) {\n      case \"video/flv\":\n        return \"flv\";\n      case \"video/mkv\":\n        return \"mkv\";\n      case \"video/mov\":\n        return \"mov\";\n      case \"video/mp4\":\n        return \"mp4\";\n      case \"video/mpeg\":\n        return \"mpeg\";\n      case \"video/mpg\":\n        return \"mpg\";\n      case \"video/three_gp\":\n        return \"three_gp\";\n      case \"video/webm\":\n        return \"webm\";\n      case \"video/wmv\":\n        return \"wmv\";\n      default:\n        return format as Bedrock.VideoFormat;\n    }\n  },\n};\n\nfunction convertCitation(\n  annotation: ContentBlock | ContentBlock.Citation\n): Bedrock.Citation {\n  return {\n    sourceContent: [\n      {\n        text:\n          typeof annotation.citedText === \"string\" ? annotation.citedText : \"\",\n      },\n    ],\n    location: {\n      documentChunk: {\n        documentIndex:\n          typeof annotation.source === \"string\"\n            ? Number(annotation.source)\n            : undefined,\n        start:\n          typeof annotation.startIndex === \"number\"\n            ? annotation.startIndex\n            : undefined,\n        end:\n          typeof annotation.endIndex === \"number\"\n            ? annotation.endIndex\n            : undefined,\n      },\n    },\n  };\n}\n\nexport function convertFromV1ToChatBedrockConverseMessage(\n  message: AIMessage\n): Array<Bedrock.ContentBlock> {\n  const modelProvider = message.response_metadata?.model_provider;\n  function* iterateContent(): Iterable<Bedrock.ContentBlock> {\n    for (const block of message.contentBlocks) {\n      if (block.type === \"text\") {\n        if (block.annotations?.length) {\n          yield {\n            citationsContent: {\n              content: [{ text: block.text }],\n              citations: block.annotations.map(convertCitation),\n            },\n          };\n        } else {\n          yield {\n            text: block.text,\n          };\n        }\n      } else if (block.type === \"audio\") {\n        // no-op\n        continue;\n      } else if (block.type === \"code_interpreter_call\") {\n        // no-op\n        continue;\n      } else if (block.type === \"code_interpreter_result\") {\n        // no-op\n        continue;\n      } else if (block.type === \"file\") {\n        const format = formatToMimeType.document(block.mimeType ?? \"\");\n        if (block.data) {\n          const bytes =\n            typeof block.data === \"string\"\n              ? Uint8Array.from(Buffer.from(block.data, \"base64\"))\n              : block.data;\n          yield {\n            document: {\n              name: block.id,\n              format,\n              source: { bytes },\n            },\n          };\n        } else if (block.fileId && block.fileId.startsWith(\"s3://\")) {\n          yield {\n            document: {\n              name: block.id,\n              format,\n              source: { s3Location: { uri: block.fileId } },\n            },\n          };\n        }\n      } else if (block.type === \"image\") {\n        const format = formatToMimeType.image(block.mimeType ?? \"\");\n        if (block.data) {\n          const bytes =\n            typeof block.data === \"string\"\n              ? Uint8Array.from(Buffer.from(block.data, \"base64\"))\n              : block.data;\n          yield {\n            image: {\n              format,\n              source: { bytes },\n            },\n          };\n        } else if (block.fileId && block.fileId.startsWith(\"s3://\")) {\n          yield {\n            image: {\n              format,\n              source: { s3Location: { uri: block.fileId } },\n            },\n          };\n        }\n      } else if (block.type === \"invalid_tool_call\") {\n        // no-op\n        continue;\n      } else if (block.type === \"reasoning\") {\n        yield {\n          reasoningContent: {\n            reasoningText: {\n              text: block.reasoning,\n            },\n          },\n        };\n      } else if (block.type === \"server_tool_call\") {\n        // no-op\n        continue;\n      } else if (block.type === \"server_tool_call_chunk\") {\n        // no-op\n        continue;\n      } else if (block.type === \"server_tool_call_result\") {\n        // no-op\n        continue;\n      } else if (block.type === \"text-plain\") {\n        // no-op\n        continue;\n      } else if (block.type === \"tool_call\") {\n        yield {\n          toolUse: {\n            toolUseId: block.id,\n            name: block.name,\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            input: block.args as any,\n          },\n        };\n      } else if (block.type === \"tool_call_chunk\") {\n        // no-op\n        continue;\n      } else if (block.type === \"video\") {\n        const format = formatToMimeType.video(block.mimeType ?? \"\");\n        if (block.data) {\n          const bytes =\n            typeof block.data === \"string\"\n              ? Uint8Array.from(Buffer.from(block.data, \"base64\"))\n              : block.data;\n          yield {\n            video: {\n              format,\n              source: { bytes },\n            },\n          };\n        } else if (block.fileId && block.fileId.startsWith(\"s3://\")) {\n          yield {\n            video: {\n              format,\n              source: { s3Location: { uri: block.fileId } },\n            },\n          };\n        }\n      } else if (block.type === \"web_search_call\") {\n        // no-op\n        continue;\n      } else if (block.type === \"web_search_result\") {\n        // no-op\n        continue;\n      } else if (\n        block.type === \"non_standard\" &&\n        modelProvider === \"bedrock-converse\"\n      ) {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        yield block as any;\n      }\n    }\n  }\n  return Array.from(iterateContent());\n}\n"],"mappings":"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"}
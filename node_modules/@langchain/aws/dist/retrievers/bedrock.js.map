{"version":3,"file":"bedrock.js","names":["resText: string","query: string","topK: number","filter?: RetrievalFilter","overrideSearchType?: SearchType"],"sources":["../../src/retrievers/bedrock.ts"],"sourcesContent":["import {\n  RetrieveCommand,\n  BedrockAgentRuntimeClient,\n  type BedrockAgentRuntimeClientConfig,\n  type SearchType,\n  type RetrievalFilter,\n} from \"@aws-sdk/client-bedrock-agent-runtime\";\n\nimport { BaseRetriever } from \"@langchain/core/retrievers\";\nimport { Document } from \"@langchain/core/documents\";\n\n/**\n * Interface for the arguments required to initialize an\n * AmazonKnowledgeBaseRetriever instance.\n */\nexport interface AmazonKnowledgeBaseRetrieverArgs {\n  knowledgeBaseId: string;\n  topK: number;\n  region: string;\n  clientOptions?: BedrockAgentRuntimeClientConfig;\n  filter?: RetrievalFilter;\n  overrideSearchType?: SearchType;\n}\n\n/**\n * Class for interacting with Amazon Bedrock Knowledge Bases, a RAG workflow oriented service\n * provided by AWS. Extends the BaseRetriever class.\n * @example\n * ```typescript\n * const retriever = new AmazonKnowledgeBaseRetriever({\n *   topK: 10,\n *   knowledgeBaseId: \"YOUR_KNOWLEDGE_BASE_ID\",\n *   region: \"us-east-2\",\n *   clientOptions: {\n *     credentials: {\n *       accessKeyId: \"YOUR_ACCESS_KEY_ID\",\n *       secretAccessKey: \"YOUR_SECRET_ACCESS_KEY\",\n *     },\n *   },\n * });\n *\n * const docs = await retriever.getRelevantDocuments(\"How are clouds formed?\");\n * ```\n */\nexport class AmazonKnowledgeBaseRetriever extends BaseRetriever {\n  static lc_name() {\n    return \"AmazonKnowledgeBaseRetriever\";\n  }\n\n  lc_namespace = [\"langchain\", \"retrievers\", \"amazon_bedrock_knowledge_base\"];\n\n  knowledgeBaseId: string;\n\n  topK: number;\n\n  bedrockAgentRuntimeClient: BedrockAgentRuntimeClient;\n\n  filter?: RetrievalFilter;\n\n  overrideSearchType?: SearchType;\n\n  constructor({\n    knowledgeBaseId,\n    topK = 10,\n    clientOptions,\n    region,\n    filter,\n    overrideSearchType,\n  }: AmazonKnowledgeBaseRetrieverArgs) {\n    super();\n\n    this.topK = topK;\n    this.filter = filter;\n    this.overrideSearchType = overrideSearchType;\n    this.bedrockAgentRuntimeClient = new BedrockAgentRuntimeClient({\n      region,\n      ...clientOptions,\n    });\n    this.knowledgeBaseId = knowledgeBaseId;\n  }\n\n  /**\n   * Cleans the result text by replacing sequences of whitespace with a\n   * single space and removing ellipses.\n   * @param resText The result text to clean.\n   * @returns The cleaned result text.\n   */\n  cleanResult(resText: string) {\n    const res = resText.replace(/\\s+/g, \" \").replace(/\\.\\.\\./g, \"\");\n    return res;\n  }\n\n  async queryKnowledgeBase(\n    query: string,\n    topK: number,\n    filter?: RetrievalFilter,\n    overrideSearchType?: SearchType\n  ) {\n    const retrieveCommand = new RetrieveCommand({\n      knowledgeBaseId: this.knowledgeBaseId,\n      retrievalQuery: {\n        text: query,\n      },\n      retrievalConfiguration: {\n        vectorSearchConfiguration: {\n          numberOfResults: topK,\n          overrideSearchType,\n          filter,\n        },\n      },\n    });\n\n    const retrieveResponse = await this.bedrockAgentRuntimeClient.send(\n      retrieveCommand\n    );\n\n    return (\n      retrieveResponse.retrievalResults?.map((result) => {\n        let source;\n        switch (result.location?.type) {\n          case \"CONFLUENCE\":\n            source = result.location?.confluenceLocation?.url;\n            break;\n          case \"S3\":\n            source = result.location?.s3Location?.uri;\n            break;\n          case \"SALESFORCE\":\n            source = result.location?.salesforceLocation?.url;\n            break;\n          case \"SHAREPOINT\":\n            source = result.location?.sharePointLocation?.url;\n            break;\n          case \"WEB\":\n            source = result.location?.webLocation?.url;\n            break;\n          default:\n            source = result.location?.s3Location?.uri;\n            break;\n        }\n\n        return {\n          pageContent: this.cleanResult(result.content?.text || \"\"),\n          metadata: {\n            source,\n            score: result.score,\n            ...result.metadata,\n          },\n        };\n      }) ?? ([] as Array<Document>)\n    );\n  }\n\n  async _getRelevantDocuments(query: string): Promise<Document[]> {\n    const docs = await this.queryKnowledgeBase(\n      query,\n      this.topK,\n      this.filter,\n      this.overrideSearchType\n    );\n    return docs;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AA4CA,IAAa,+BAAb,cAAkD,cAAc;CAC9D,OAAO,UAAU;AACf,SAAO;CACR;CAED,eAAe;EAAC;EAAa;EAAc;CAAgC;CAE3E;CAEA;CAEA;CAEA;CAEA;CAEA,YAAY,EACV,iBACA,OAAO,IACP,eACA,QACA,QACA,oBACiC,EAAE;EACnC,OAAO;EAEP,KAAK,OAAO;EACZ,KAAK,SAAS;EACd,KAAK,qBAAqB;EAC1B,KAAK,4BAA4B,IAAI,0BAA0B;GAC7D;GACA,GAAG;EACJ;EACD,KAAK,kBAAkB;CACxB;;;;;;;CAQD,YAAYA,SAAiB;EAC3B,MAAM,MAAM,QAAQ,QAAQ,QAAQ,IAAI,CAAC,QAAQ,WAAW,GAAG;AAC/D,SAAO;CACR;CAED,MAAM,mBACJC,OACAC,MACAC,QACAC,oBACA;EACA,MAAM,kBAAkB,IAAI,gBAAgB;GAC1C,iBAAiB,KAAK;GACtB,gBAAgB,EACd,MAAM,MACP;GACD,wBAAwB,EACtB,2BAA2B;IACzB,iBAAiB;IACjB;IACA;GACD,EACF;EACF;EAED,MAAM,mBAAmB,MAAM,KAAK,0BAA0B,KAC5D,gBACD;AAED,SACE,iBAAiB,kBAAkB,IAAI,CAAC,WAAW;GACjD,IAAI;AACJ,WAAQ,OAAO,UAAU,MAAzB;IACE,KAAK;KACH,SAAS,OAAO,UAAU,oBAAoB;AAC9C;IACF,KAAK;KACH,SAAS,OAAO,UAAU,YAAY;AACtC;IACF,KAAK;KACH,SAAS,OAAO,UAAU,oBAAoB;AAC9C;IACF,KAAK;KACH,SAAS,OAAO,UAAU,oBAAoB;AAC9C;IACF,KAAK;KACH,SAAS,OAAO,UAAU,aAAa;AACvC;IACF;KACE,SAAS,OAAO,UAAU,YAAY;AACtC;GACH;AAED,UAAO;IACL,aAAa,KAAK,YAAY,OAAO,SAAS,QAAQ,GAAG;IACzD,UAAU;KACR;KACA,OAAO,OAAO;KACd,GAAG,OAAO;IACX;GACF;EACF,EAAC,IAAK,CAAE;CAEZ;CAED,MAAM,sBAAsBH,OAAoC;EAC9D,MAAM,OAAO,MAAM,KAAK,mBACtB,OACA,KAAK,MACL,KAAK,QACL,KAAK,mBACN;AACD,SAAO;CACR;AACF"}
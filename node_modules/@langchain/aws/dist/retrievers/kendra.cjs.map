{"version":3,"file":"kendra.cjs","names":["BaseRetriever","KendraClient","title?: string","excerpt?: string","resText: string","value: DocumentAttributeValue","documentAttributes?: DocumentAttribute[]","attributes: { [key: string]: unknown }","item: RetrieveResultItem","Document","response: RetrieveCommandOutput","pageSize: number","item: QueryResultItem","response: QueryCommandOutput","query: string","topK: number","attributeFilter?: AttributeFilter","RetrieveCommand","QueryCommand"],"sources":["../../src/retrievers/kendra.ts"],"sourcesContent":["import type {\n  AttributeFilter,\n  DocumentAttribute,\n  DocumentAttributeValue,\n  KendraClientConfig,\n  QueryCommandOutput,\n  QueryResultItem,\n  RetrieveCommandOutput,\n  RetrieveResultItem,\n} from \"@aws-sdk/client-kendra\";\nimport {\n  KendraClient,\n  QueryCommand,\n  RetrieveCommand,\n} from \"@aws-sdk/client-kendra\";\n\nimport { BaseRetriever } from \"@langchain/core/retrievers\";\nimport { Document } from \"@langchain/core/documents\";\n\n/**\n * Interface for the arguments required to initialize an\n * AmazonKendraRetriever instance.\n */\nexport interface AmazonKendraRetrieverArgs {\n  indexId: string;\n  topK: number;\n  region: string;\n  attributeFilter?: AttributeFilter;\n  clientOptions?: KendraClientConfig;\n}\n\n/**\n * Class for interacting with Amazon Kendra, an intelligent search service\n * provided by AWS. Extends the BaseRetriever class.\n * @example\n * ```typescript\n * const retriever = new AmazonKendraRetriever({\n *   topK: 10,\n *   indexId: \"YOUR_INDEX_ID\",\n *   region: \"us-east-2\",\n *   clientOptions: {\n *     credentials: {\n *       accessKeyId: \"YOUR_ACCESS_KEY_ID\",\n *       secretAccessKey: \"YOUR_SECRET_ACCESS_KEY\",\n *     },\n *   },\n * });\n *\n * const docs = await retriever.getRelevantDocuments(\"How are clouds formed?\");\n * ```\n */\nexport class AmazonKendraRetriever extends BaseRetriever {\n  static lc_name() {\n    return \"AmazonKendraRetriever\";\n  }\n\n  lc_namespace = [\"langchain\", \"retrievers\", \"amazon_kendra\"];\n\n  indexId: string;\n\n  topK: number;\n\n  kendraClient: KendraClient;\n\n  attributeFilter?: AttributeFilter;\n\n  constructor({\n    indexId,\n    topK = 10,\n    clientOptions,\n    attributeFilter,\n    region,\n  }: AmazonKendraRetrieverArgs) {\n    super();\n\n    if (!region) {\n      throw new Error(\"Please pass regionName field to the constructor!\");\n    }\n\n    if (!indexId) {\n      throw new Error(\"Please pass Kendra Index Id to the constructor\");\n    }\n\n    this.topK = topK;\n    this.kendraClient = new KendraClient({\n      region,\n      ...clientOptions,\n    });\n    this.attributeFilter = attributeFilter;\n    this.indexId = indexId;\n  }\n\n  // A method to combine title and excerpt into a single string.\n  /**\n   * Combines title and excerpt into a single string.\n   * @param title The title of the document.\n   * @param excerpt An excerpt from the document.\n   * @returns A single string combining the title and excerpt.\n   */\n  combineText(title?: string, excerpt?: string): string {\n    let text = \"\";\n    if (title) {\n      text += `Document Title: ${title}\\n`;\n    }\n    if (excerpt) {\n      text += `Document Excerpt: \\n${excerpt}\\n`;\n    }\n    return text;\n  }\n\n  // A method to clean the result text by replacing sequences of whitespace with a single space and removing ellipses.\n  /**\n   * Cleans the result text by replacing sequences of whitespace with a\n   * single space and removing ellipses.\n   * @param resText The result text to clean.\n   * @returns The cleaned result text.\n   */\n  cleanResult(resText: string) {\n    const res = resText.replace(/\\s+/g, \" \").replace(/\\.\\.\\./g, \"\");\n    return res;\n  }\n\n  // A method to extract the attribute value from a DocumentAttributeValue object.\n  /**\n   * Extracts the attribute value from a DocumentAttributeValue object.\n   * @param value The DocumentAttributeValue object to extract the value from.\n   * @returns The extracted attribute value.\n   */\n  getDocAttributeValue(value: DocumentAttributeValue) {\n    if (value.DateValue) {\n      return value.DateValue;\n    }\n    if (value.LongValue) {\n      return value.LongValue;\n    }\n    if (value.StringListValue) {\n      return value.StringListValue;\n    }\n    if (value.StringValue) {\n      return value.StringValue;\n    }\n    return \"\";\n  }\n\n  // A method to extract the attribute key-value pairs from an array of DocumentAttribute objects.\n  /**\n   * Extracts the attribute key-value pairs from an array of\n   * DocumentAttribute objects.\n   * @param documentAttributes The array of DocumentAttribute objects to extract the key-value pairs from.\n   * @returns An object containing the extracted attribute key-value pairs.\n   */\n  getDocAttributes(documentAttributes?: DocumentAttribute[]): {\n    [key: string]: unknown;\n  } {\n    const attributes: { [key: string]: unknown } = {};\n    if (documentAttributes) {\n      for (const attr of documentAttributes) {\n        if (attr.Key && attr.Value) {\n          attributes[attr.Key] = this.getDocAttributeValue(attr.Value);\n        }\n      }\n    }\n    return attributes;\n  }\n\n  // A method to convert a RetrieveResultItem object into a Document object.\n  /**\n   * Converts a RetrieveResultItem object into a Document object.\n   * @param item The RetrieveResultItem object to convert.\n   * @returns A Document object.\n   */\n  convertRetrieverItem(item: RetrieveResultItem) {\n    const title = item.DocumentTitle || \"\";\n    const excerpt = item.Content ? this.cleanResult(item.Content) : \"\";\n    const pageContent = this.combineText(title, excerpt);\n    const source = item.DocumentURI;\n    const attributes = this.getDocAttributes(item.DocumentAttributes);\n    const metadata = {\n      source,\n      title,\n      excerpt,\n      document_attributes: attributes,\n    };\n\n    return new Document({ pageContent, metadata });\n  }\n\n  // A method to extract the top-k documents from a RetrieveCommandOutput object.\n  /**\n   * Extracts the top-k documents from a RetrieveCommandOutput object.\n   * @param response The RetrieveCommandOutput object to extract the documents from.\n   * @param pageSize The number of documents to extract.\n   * @returns An array of Document objects.\n   */\n  getRetrieverDocs(\n    response: RetrieveCommandOutput,\n    pageSize: number\n  ): Document[] {\n    if (!response.ResultItems) return [];\n    const { length } = response.ResultItems;\n    const count = length < pageSize ? length : pageSize;\n\n    return response.ResultItems.slice(0, count).map((item) =>\n      this.convertRetrieverItem(item)\n    );\n  }\n\n  // A method to extract the excerpt text from a QueryResultItem object.\n  /**\n   * Extracts the excerpt text from a QueryResultItem object.\n   * @param item The QueryResultItem object to extract the excerpt text from.\n   * @returns The extracted excerpt text.\n   */\n  getQueryItemExcerpt(item: QueryResultItem) {\n    if (\n      item.AdditionalAttributes &&\n      item.AdditionalAttributes.length &&\n      item.AdditionalAttributes[0].Key === \"AnswerText\"\n    ) {\n      if (!item.AdditionalAttributes) {\n        return \"\";\n      }\n      if (!item.AdditionalAttributes[0]) {\n        return \"\";\n      }\n\n      return this.cleanResult(\n        item.AdditionalAttributes[0].Value?.TextWithHighlightsValue?.Text || \"\"\n      );\n    } else if (item.DocumentExcerpt) {\n      return this.cleanResult(item.DocumentExcerpt.Text || \"\");\n    } else {\n      return \"\";\n    }\n  }\n\n  // A method to convert a QueryResultItem object into a Document object.\n  /**\n   * Converts a QueryResultItem object into a Document object.\n   * @param item The QueryResultItem object to convert.\n   * @returns A Document object.\n   */\n  convertQueryItem(item: QueryResultItem) {\n    const title = item.DocumentTitle?.Text || \"\";\n    const excerpt = this.getQueryItemExcerpt(item);\n    const pageContent = this.combineText(title, excerpt);\n    const source = item.DocumentURI;\n    const attributes = this.getDocAttributes(item.DocumentAttributes);\n    const metadata = {\n      source,\n      title,\n      excerpt,\n      document_attributes: attributes,\n    };\n\n    return new Document({ pageContent, metadata });\n  }\n\n  // A method to extract the top-k documents from a QueryCommandOutput object.\n  /**\n   * Extracts the top-k documents from a QueryCommandOutput object.\n   * @param response The QueryCommandOutput object to extract the documents from.\n   * @param pageSize The number of documents to extract.\n   * @returns An array of Document objects.\n   */\n  getQueryDocs(response: QueryCommandOutput, pageSize: number) {\n    if (!response.ResultItems) return [];\n    const { length } = response.ResultItems;\n    const count = length < pageSize ? length : pageSize;\n    return response.ResultItems.slice(0, count).map((item) =>\n      this.convertQueryItem(item)\n    );\n  }\n\n  // A method to send a retrieve or query request to Kendra and return the top-k documents.\n  /**\n   * Sends a retrieve or query request to Kendra and returns the top-k\n   * documents.\n   * @param query The query to send to Kendra.\n   * @param topK The number of top documents to return.\n   * @param attributeFilter Optional filter to apply when retrieving documents.\n   * @returns A Promise that resolves to an array of Document objects.\n   */\n  async queryKendra(\n    query: string,\n    topK: number,\n    attributeFilter?: AttributeFilter\n  ) {\n    const retrieveCommand = new RetrieveCommand({\n      IndexId: this.indexId,\n      QueryText: query,\n      PageSize: topK,\n      AttributeFilter: attributeFilter,\n    });\n\n    const retrieveResponse = await this.kendraClient.send(retrieveCommand);\n    const retriveLength = retrieveResponse.ResultItems?.length;\n\n    if (retriveLength === 0) {\n      // Retrieve API returned 0 results, call query API\n      const queryCommand = new QueryCommand({\n        IndexId: this.indexId,\n        QueryText: query,\n        PageSize: topK,\n        AttributeFilter: attributeFilter,\n      });\n\n      const queryResponse = await this.kendraClient.send(queryCommand);\n      return this.getQueryDocs(queryResponse, this.topK);\n    } else {\n      return this.getRetrieverDocs(retrieveResponse, this.topK);\n    }\n  }\n\n  async _getRelevantDocuments(query: string): Promise<Document[]> {\n    const docs = await this.queryKendra(query, this.topK, this.attributeFilter);\n    return docs;\n  }\n}\n"],"mappings":"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"}
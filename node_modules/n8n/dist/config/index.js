"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const convict_1 = __importDefault(require("convict"));
const dotenv_1 = __importDefault(require("dotenv"));
const fs_1 = require("fs");
const n8n_workflow_1 = require("n8n-workflow");
const constants_1 = require("../constants");
if (constants_1.inE2ETests) {
    process.env.EXECUTIONS_PROCESS = 'main';
    process.env.N8N_DIAGNOSTICS_ENABLED = 'false';
    process.env.N8N_PUBLIC_API_DISABLED = 'true';
    process.env.EXTERNAL_FRONTEND_HOOKS_URLS = '';
    process.env.N8N_PERSONALIZATION_ENABLED = 'false';
    process.env.N8N_AI_ENABLED = 'true';
}
else if (constants_1.inTest) {
    process.env.N8N_LOG_LEVEL = 'silent';
    process.env.N8N_ENCRYPTION_KEY = 'test-encryption-key';
    process.env.N8N_PUBLIC_API_DISABLED = 'true';
    process.env.SKIP_STATISTICS_EVENTS = 'true';
}
else {
    dotenv_1.default.config();
}
const schema_1 = require("./schema");
const config = (0, convict_1.default)(schema_1.schema, { args: [] });
config.getEnv = config.get;
if (!constants_1.inE2ETests && !constants_1.inTest) {
    const { N8N_CONFIG_FILES } = process.env;
    if (N8N_CONFIG_FILES !== undefined) {
        const configFiles = N8N_CONFIG_FILES.split(',');
        console.debug('Loading config overwrites', configFiles);
        config.loadFile(configFiles);
    }
    Object.entries(process.env).forEach(([envName, fileName]) => {
        var _a;
        if (envName.endsWith('_FILE') && fileName) {
            const configEnvName = envName.replace(/_FILE$/, '');
            const key = (_a = config._env[configEnvName]) === null || _a === void 0 ? void 0 : _a[0];
            if (key) {
                let value;
                try {
                    value = (0, fs_1.readFileSync)(fileName, 'utf8');
                }
                catch (error) {
                    if (error.code === 'ENOENT') {
                        throw new Error(`The file "${fileName}" could not be found.`);
                    }
                    throw error;
                }
                config.set(key, value);
            }
        }
    });
}
config.validate({
    allowed: 'strict',
});
(0, n8n_workflow_1.setGlobalState)({
    defaultTimezone: config.getEnv('generic.timezone'),
});
exports.default = config;
//# sourceMappingURL=index.js.map
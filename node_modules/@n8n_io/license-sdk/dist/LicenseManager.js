"use strict";var D=Object.create;var g=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var N=(s,e)=>{for(var t in e)g(s,t,{get:e[t],enumerable:!0})},E=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of x(e))!M.call(s,n)&&n!==t&&g(s,n,{get:()=>e[n],enumerable:!(i=R(e,n))||i.enumerable});return s};var I=(s,e,t)=>(t=s!=null?D(L(s)):{},E(e||!s||!s.__esModule?g(t,"default",{value:s,enumerable:!0}):t,s)),S=s=>E(g({},"__esModule",{value:!0}),s);var B={};N(B,{LicenseManager:()=>m});module.exports=S(B);var f=I(require("crypto-js")),b=require("node-machine-id"),F=I(require("node-rsa")),p=require("crypto");var o=require("undici"),T=require("url"),O=Object.fromEntries(["http","https"].map(s=>{let e=process.env[`${s}_proxy`];return e?[`${s}:`,new o.ProxyAgent(e)]:[]})),k=(process.env.no_proxy??"").split(",").map(s=>s.trim()),P=(0,o.getGlobalDispatcher)();(0,o.setGlobalDispatcher)(new class extends o.Dispatcher{dispatch(s,e){if(s.origin){let{host:t,protocol:i}=typeof s.origin=="string"?new T.URL(s.origin):s.origin;if(!k.some(n=>n.startsWith(".")?t.endsWith(n):t===n)){let n=O[i];n&&n.dispatch(s,e)}}return P.dispatch(s,e)}});async function d(s,e,t={}){let i=new AbortController,n=setTimeout(()=>{i.abort()},t.timeoutInMs??3e4);try{let r=await(0,o.fetch)(s,{method:"post",body:JSON.stringify(e),headers:{"Content-Type":"application/json"},signal:i.signal}),a=await r.json();return{status:r.status,data:a}}catch(r){throw new Error("Connection Error",{cause:r})}finally{clearTimeout(n)}}var m=class{constructor(e){this.isInitializationCompleted=!1;this.isShuttingDown=!1;this.config=e,this.config.logger?this.logger=this.config.logger:this.logger={error(){console.log("ERROR:",...arguments)},warn(){console.log("WARN:",...arguments)},info(){console.log("INFO:",...arguments)},debug(){console.log("DEBUG:",...arguments)}},this.x509IssuerCert=new p.X509Certificate(`-----BEGIN CERTIFICATE-----
MIIFDDCCAvQCCQCWGBewlWbp0DANBgkqhkiG9w0BAQsFADBIMQswCQYDVQQGEwJE
RTEPMA0GA1UECAwGQmVybGluMQ8wDQYDVQQHDAZCZXJsaW4xFzAVBgNVBAMMDmxp
Y2Vuc2UubjhuLmlvMB4XDTIyMDYyNDA0MDkzM1oXDTQ5MTEwOTA0MDkzM1owSDEL
MAkGA1UEBhMCREUxDzANBgNVBAgMBkJlcmxpbjEPMA0GA1UEBwwGQmVybGluMRcw
FQYDVQQDDA5saWNlbnNlLm44bi5pbzCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCC
AgoCggIBANK6Uj5CSyPaa2rf/bwH/AqzzINeWg4n94pECv4p8tsjy0+ZscodNn7Q
IvYW/6IUpax8fZvHCSqu0L7fsgLkw0+HDLlsln+ryI/3h1ElVZm67BfqOvhSfPj+
btxcP8EtS+6hbf74sqPEBFD0wikKhIPGdtBolp7rLXfTGs+5eMqSA5q4W1V+HUUU
zgaCdchzlHGTdIICNpbRozGeFTIIx1MPzMie+4zIs6i680efx2KJVZWsa2WuCSED
+b0gSRTgoKQ3B7JjxJKfzHdOdM6JxhkCjrJIkJCrZL7wFypn+wMHsVFrsw/80WkS
dwBj/RqCPzKcRwnxs0WNLhkyT/XCMS/1pNzPymdFADu2tEZjhFsa5ziIhdoQz8po
Efheyg3mOZDWyu6oyHCLH9lUlsNjV9zZ6RICgvHZvHPmPqOLPomy4Qymq2osuH+S
28rwEy0W3DCEfuS3dZHrSQfohGC9EAyyFAIPSGhTJSYJl0oNBZjpRM+jAm9ER7PM
K70/7g6z8uIgKa8/SD/Pezd/aWzxH/tOokAF5X5o5TzSOwVzqOJzY06EZC7CJnhs
sigAJTy1trZJBcZuWnKY5FqrK3QzjsQ9sWM0tRocfNOYmD21mubNo+RmMMo3kvYL
JoBfap/cuP6kx3OiRzBJ4luTEa6nRIYy+EjcPaN3+9L5iEZ9/NABAgMBAAEwDQYJ
KoZIhvcNAQELBQADggIBAIUpJ0Rh6C92cJqy6iehS8c77r1prj62gr6Acdy5QGh8
ax30ANDbPtkezVIIBk+0JjLkMxr3mwqCRsPgMshPcxhZwEafmZrWPPGRVsOfukB3
Gp10cIv1YmZ7AFY4i/izj5184+A+GjxrJBULQG1JfX4c7KW06Kaps85AaX/Tp0fl
/hZ6oUe48aSSTuAW38hWZ5jCpBqfFyQ15ablJZt0fB8NkXEdFUcUEt/OHJfqF5fP
Nt5PWC1AuBxzSbzjwabOy/M4r8m5CzCeXSIjqbcsAq52myMoxvNrjKRtucQ7CjqK
LR6WdhMf+NLvyTI+evXMoXpDzlevkCpz17uDiDt9XrmvLSf3Ff8mdTRwzVmOmHfc
Ruz5v7WBR4cpBR/sC+WxOw9heLMHgYhPyRUM4voo55EcJGusXr/iavblBAnI0GUw
uMNs3MjEmfbaBV1K0GKG5UToF9UmUxxVmTcRUZrAQX+yBkRezDTpOQuRnB58BDQP
A62lcgZlikzJw3lHue33qAudyUrUmjfHGll7GFQNeLO42jPMeM4NJiNIrBZ7j0uD
4slHdDi/44PHcKchvde/5k7ZJMi6OC1Vu+bOnKvzhnWQIOkHFQ55m13oslV2ozZT
/oqhn/8/LeV0ooZuYnBeRkRTveniUeho2OFe5xZvWSSfuBrbHt9+zBg+5MWPUTIJ
-----END CERTIFICATE-----`),this.config.autoRenewEnabled=this.config.autoRenewEnabled??!0,this.config.renewOnInit=this.config.renewOnInit??!1,this.config.offlineMode=this.config.offlineMode??!1,this.config.autoRenewOffset=this.config.autoRenewOffset??60*60*72,this.config.server=this.config.server??"https://license.n8n.io/v1"}log(e,t){this.logger[t](`[license] ${e}`)}isInitialized(){return this.isInitializationCompleted}async initialize(){this.isInitialized()||(this.deviceFingerprint=await this.computeDeviceFingerprint(),this.log(`initializing for deviceFingerprint ${this.deviceFingerprint}`,"debug"),await this.initCert(),this.checkUpcomingEntitlementChangesCron=setInterval(()=>this.setTimerForNextEntitlementChange(),1e3*60*15),this.config.autoRenewEnabled&&(this.config.renewOnInit&&await this.renewalCron({force:!0}),this.renewalIntervalPointer=setInterval(()=>this.renewalCron({force:!1}),1e3*60*15)),this.isInitializationCompleted=!0)}async reload(){this.reset(),await this.initialize()}reset(){this.config.autoRenewEnabled&&clearInterval(this.renewalIntervalPointer),this.checkUpcomingEntitlementChangesCron&&clearInterval(this.checkUpcomingEntitlementChangesCron),this.entitlementChangeTimeoutPointer&&clearTimeout(this.entitlementChangeTimeoutPointer),this.licenseCert=void 0,this.deviceFingerprint=void 0,this.isInitializationCompleted=!1}async computeDeviceFingerprint(){return this.config.deviceFingerprint&&typeof this.config.deviceFingerprint=="function"?await this.config.deviceFingerprint():await(0,b.machineId)()}async activate(e){if(!this.isInitialized())throw new Error("activation failed because SDK was not yet initialized");if(this.isShuttingDown)throw new Error("activation failed because SDK is shutting down");if(this.config.offlineMode)throw new Error("activation failed because SDK is in offline mode");let t={reservationId:e,tenantId:this.config.tenantId,productIdentifier:this.config.productIdentifier,deviceFingerprint:this.deviceFingerprint};this.hasCert()&&(t.consumerId=this.licenseCert.consumerId,t.renewalToken=this.licenseCert.renewalToken);let i;try{i=await d(`${this.config.server}/activate`,t,{timeoutInMs:1e4})}catch(n){throw this.log("license activation failed: "+n.message,"warn"),new Error(n.message)}if(i.status==200){if(!i.data.hasOwnProperty("licenseKey")||!i.data.hasOwnProperty("x509"))throw this.log("unexpected server response","warn"),new Error("unexpected server response");let n=this.stringifyCertContainer({licenseKey:i.data.licenseKey,x509:i.data.x509});await this.config.saveCertStr(n),await this.initCert(),this.log("license successfully activated","info"),(i.data.detachedEntitlementsCount??0>0)&&this.log(`skipped importing ${i.data.detachedEntitlementsCount} floating entitlements which are currently in use elsewhere`,"info")}else{let n=`license activation failed: ${i.data.message??"unknown reason"}`,r=new Error(n);throw i.data.errorId&&(r.errorId=i.data.errorId),this.log(n,"warn"),r}}async renew({detachFloatingEntitlements:e=!1}={}){if(!this.hasCert())throw new Error("renewal failed because current cert is not initialized");if(this.licenseCert.isEphemeral)return;if(this.isTerminated())throw new Error("renewal failed because current cert was terminated");if(this.config.offlineMode)throw new Error("renewal failed because SDK is in offline mode");let t=this.config.collectUsageMetrics?await this.config.collectUsageMetrics():[],i;try{i=await d(`${this.config.server}/renew`,{consumerId:this.licenseCert.consumerId,tenantId:this.config.tenantId,deviceFingerprint:this.deviceFingerprint,renewalToken:this.licenseCert.renewalToken,detachFloatingEntitlements:e,usageMetrics:t},{timeoutInMs:1e4})}catch(r){throw this.log("license renewal failed: "+r.message,"warn"),new Error(r.message)}let n=i.data;if(i.status==200){if(!n.hasOwnProperty("licenseKey")||!n.hasOwnProperty("x509"))throw this.log("license renewal failed: unexpected server response","warn"),new Error("unexpected server response");let r=this.stringifyCertContainer({licenseKey:n.licenseKey,x509:n.x509});await this.config.saveCertStr(r),this.log("license successfully renewed","debug"),(n.detachedEntitlementsCount??0>0)&&this.log(`skipped importing ${n.detachedEntitlementsCount} floating entitlements which are currently in use elsewhere`,"info"),await this.initCert()}else{let r=`license renewal failed: ${n.message??"unknown reason"}`;this.log(r,"warn");let a=new Error(r);throw n.errorId&&(a.errorId=n.errorId,["NOT_FOUND","CONSUMER_TERMINATED"].includes(n.errorId)&&(this.log("license was terminated by the server. Deleting local cert.","warn"),await this.config.saveCertStr(""),await this.initCert())),a}}hasCert(){return!!this.licenseCert}isTerminated(){if(!this.hasCert())throw new Error("Cert is not initialized");let e=new Date;return this.licenseCert.terminatesAt<e}getExpiryDate(){if(!this.hasCert())throw new Error("Cert is not initialized");return this.licenseCert.expiresAt}getTerminationDate(){if(!this.hasCert())throw new Error("Cert is not initialized");return this.licenseCert.terminatesAt}isValid(e=!0){let t=r=>{e&&this.log(r,"debug")};if(!this.hasCert())return t("cert is invalid because it is undefined"),!1;let i=this.licenseCert,n=new Date;return i.expiresAt<n?(t("cert is invalid because it has expired"),!1):i.terminatesAt<n?(t("cert is invalid because it was terminated"),!1):i.createdAt.getTime()-3e5>n.getTime()?(t("cert is invalid because system clock is out of sync"),!1):i.deviceLock&&this.deviceFingerprint!==i.deviceFingerprint?(t("cert is invalid because device fingerprint does not match"),!1):this.config.tenantId!==i.tenantId?(t("cert is invalid because tenant ID does not match"),!1):!0}hasFeatureEnabled(e,t=!0){return!!this.getFeatureValue(e,t)}hasFeatureDefined(e,t=!0){return this.getFeatureValue(e,t)!==void 0}hasQuotaLeft(e,t){let i=this.getFeatureValue(e);if(i===void 0)return!1;if(typeof i!="number")throw new Error(`${e} cannot be used as quota as it is not numeric`);return i===-1?!0:Math.ceil(t)<Math.ceil(i)}getFeatureValue(e,t=!0){if(!this.hasCert()||t&&!this.isValid())return;let i=this.getFeatures();if(!!i.hasOwnProperty(e))return i[e]}updateCurrentFeatures(){if(!this.hasCert())return;let e=new Date;(this.licenseCert.expiresAt<e||this.licenseCert.terminatesAt<e)&&(this.currentFeatures={}),this.currentFeatures=this.licenseCert.entitlements.filter(t=>t.validFrom<=e&&t.validTo>e).sort((t,i)=>t.validFrom.getTime()-i.validFrom.getTime()).reduce((t,i)=>({...t,...i.features,...i.featureOverrides}),{})}getFeatures(){return this.hasCert()?this.currentFeatures??{}:{}}getCurrentEntitlements(){if(!this.hasCert())return[];let e=new Date;return this.licenseCert.entitlements.filter(t=>t.validFrom<=e&&t.validTo>e)}getManagementJwt(){return this.licenseCert?this.licenseCert.managementJwt:""}isRenewalDue(){if(!this.licenseCert||this.licenseCert.isEphemeral)return!1;let e=new Date().getTime(),t=1e3*60*15,i=1e3*60*20,n=this.licenseCert.expiresAt.getTime(),r=this.licenseCert.issuedAt.getTime(),a=this.licenseCert.terminatesAt.getTime(),c=e>n-this.config.autoRenewOffset*1e3&&e<a,l=this.getCurrentEntitlements().find(u=>e>=u.validTo.getTime()-t&&e<=u.validTo.getTime())!==void 0&&r<e-i;return c||l}toString(){var e,t,i,n,r,a,c,l,u,C,w,v,y;return`## CONSUMER CONFIG ##
tenantId: ${this.config.tenantId??"<n/a>"}
productIdentifier: ${this.config.productIdentifier??"<n/a>"}
deviceFingerprint: ${this.deviceFingerprint??"<n/a>"}
--
## LICENSE CERT ##
version: ${((e=this.licenseCert)==null?void 0:e.version)??"<n/a>"}
tenantId: ${((t=this.licenseCert)==null?void 0:t.tenantId)??"<n/a>"} ${((i=this.licenseCert)==null?void 0:i.tenantId)!==this.config.tenantId?"(!)":""}
consumerId: ${((n=this.licenseCert)==null?void 0:n.consumerId)??"<n/a>"}
deviceFingerprint: ${((r=this.licenseCert)==null?void 0:r.deviceFingerprint)??"<n/a>"} ${((a=this.licenseCert)==null?void 0:a.deviceFingerprint)!==this.deviceFingerprint?"(!)":""}
createdAt: ${((c=this.licenseCert)==null?void 0:c.createdAt)??"<n/a>"}
issuedAt: ${((l=this.licenseCert)==null?void 0:l.issuedAt)??"<n/a>"}
expiresAt: ${((u=this.licenseCert)==null?void 0:u.expiresAt)??"<n/a>"}
terminatesAt: ${((C=this.licenseCert)==null?void 0:C.terminatesAt)??"<n/a>"}
isEphemeral: ${((w=this.licenseCert)==null?void 0:w.isEphemeral)??"<n/a>"}
isValid: ${this.isValid(!1)}
isRenewalDue: ${this.isRenewalDue()}
entitlements: ${((v=this.licenseCert)==null?void 0:v.entitlements.length)??0}
`+((y=this.licenseCert)==null?void 0:y.entitlements.map((h,A)=>`--
## ENTITLEMENT ${A+1} ##
id: ${h.id}
productId: ${h.productId}
validFrom: ${h.validFrom}
validTo: ${h.validTo}
features: ${JSON.stringify(h.features)}
featureOverrides: ${JSON.stringify(h.featureOverrides)}
`).join(""))}triggerOnFeatureChangeCallback(){this.config.onFeatureChange&&this.config.onFeatureChange(this.currentFeatures??{})}setTimerForNextEntitlementChange(){if(!this.hasCert())return;let e=new Date().getTime(),t=new Set;t.add(this.licenseCert.expiresAt.getTime()-e),t.add(this.licenseCert.terminatesAt.getTime()-e);let i=[...this.licenseCert.entitlements.reduce((r,a)=>(r.add(a.validFrom.getTime()-e),r.add(a.validTo.getTime()-e),r),t)].filter(r=>r>=0&&r<=15*60*1e3).sort((r,a)=>r-a);if(i.length===0)return;let n=i[0];clearTimeout(this.entitlementChangeTimeoutPointer),this.entitlementChangeTimeoutPointer=setTimeout(()=>{this.updateCurrentFeatures(),this.triggerOnFeatureChangeCallback(),this.setTimerForNextEntitlementChange()},n+1e3)}async renewalCron({force:e}){if(e||this.isRenewalDue()){this.log("attempting license renewal","debug");try{await this.renew()}catch{}}}async initCert(){if(!this.isShuttingDown)try{let e=await this.config.loadCertStr();if(!e){this.licenseCert=void 0;return}if(e.length<50)throw new Error("cert string is undefined or too short");let{x509:t,licenseKey:i}=this.parseLicenseCertContainerStr(e);if(this.x509Cert=new p.X509Certificate(t),!this.x509Cert.checkIssued(this.getIssuerCert()))throw new Error("cert was not issued by an approved issuer");let r=this.x509Cert.publicKey.export({format:"pem",type:"pkcs1"});this.key=new F.default(r),this.licenseCert=this.parseLicenseKeyStr(i),this.updateCurrentFeatures(),this.triggerOnFeatureChangeCallback(),this.setTimerForNextEntitlementChange()}catch(e){this.log(`cert could not be initialized. ${e instanceof Error?e.message:""}`,"error")}}stringifyCertContainer(e){let t=JSON.stringify(e);return Buffer.from(t).toString("base64")}parseLicenseCertContainerStr(e){let t=Buffer.from(e,"base64").toString("ascii"),i=JSON.parse(t);if(!i.hasOwnProperty("licenseKey")||!i.hasOwnProperty("x509"))throw new Error("license cert container could not be parsed");return i}parseLicenseKeyStr(e){let t=this.validateLicenseKey(e),i={...t};return i.createdAt=new Date(t.createdAt),i.issuedAt=new Date(t.issuedAt),i.expiresAt=new Date(t.expiresAt),i.terminatesAt=new Date(t.terminatesAt),i.entitlements=i.entitlements.map(n=>(n.validFrom=new Date(n.validFrom),n.validTo=new Date(n.validTo),n)),i}validateLicenseKey(e){e=e.replace(/(\r\n|\n|\r)/gm,"");let t=e.match(/^-----BEGIN LICENSE KEY-----(?<encryptedSymmetricKey>.+\|\|)(?<encryptedData>.+)\|\|(?<signature>.+)-----END LICENSE KEY-----$/);if(!t)throw new Error("license key could not be parsed");let i=t.groups.encryptedSymmetricKey,n=t.groups.encryptedData,r=t.groups.signature,a,c;try{a=this.key.decryptPublic(i,"utf8")}catch{throw new Error("Invalid data: Could not extract symmetric key")}try{c=f.default.AES.decrypt(n,a).toString(f.default.enc.Utf8)}catch{throw new Error("Invalid Data: Could not decrypt data with key found")}if(this.key.verify(Buffer.from(c),r,"utf8","base64"))return JSON.parse(c);throw new Error("License Key signature invalid")}getIssuerCert(){return this.x509IssuerCert}async shutdown(){if(this.isShuttingDown=!0,this.config.autoRenewEnabled&&clearInterval(this.renewalIntervalPointer),this.checkUpcomingEntitlementChangesCron&&clearInterval(this.checkUpcomingEntitlementChangesCron),this.entitlementChangeTimeoutPointer&&clearTimeout(this.entitlementChangeTimeoutPointer),!this.hasCert())return;this.licenseCert.entitlements.some(t=>t.isFloatable??!1)&&await this.renew({detachFloatingEntitlements:!0})}};0&&(module.exports={LicenseManager});
//# sourceMappingURL=LicenseManager.js.map